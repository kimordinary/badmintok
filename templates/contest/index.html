{% extends "base.html" %}
{% load contest_filters %}

{% block title %}배드민톡 - 전국 배드민턴 대회{% endblock %}
{% block og_title_meta %}<meta property="og:title" content="배드민톡 - 전국 배드민턴 대회">{% endblock %}
{% block extra_head %}
<meta name="description" content="전국 배드민턴 대회 일정, 접수 정보, 대회장 위치, 참가비, 상금 정보를 한눈에 확인하세요. 승급대회부터 지역대회까지 모든 대회 정보를 제공합니다.">
<meta property="og:description" content="전국 배드민턴 대회 일정, 접수 정보, 대회장 위치, 참가비, 상금 정보를 한눈에 확인하세요. 승급대회부터 지역대회까지 모든 대회 정보를 제공합니다.">
<style>
    /* 대회 리스트 + 사이드바 7:3 그리드 */
    .contest-grid {
        display: grid;
        grid-template-columns: 7fr 3fr;
        gap: 24px;
        align-items: flex-start;
    }

    .contest-grid-sidebar {
        /* 우측 사이드바 베이스 스타일 */
        min-height: 100px;
        align-self: flex-start;
    }

    .contest-list-section {
        align-self: flex-start;
    }

    .closing-soon-box {
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        padding: 16px 16px 12px;
    }

    .closing-soon-title {
        margin: 0 0 4px 0;
        font-size: 15px;
        font-weight: 700;
        color: #0f172a;
    }

    .closing-soon-subtitle {
        margin: 0 0 12px 0;
        font-size: 12px;
        color: #94a3b8;
    }

    .closing-soon-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 380px;
        overflow-y: auto;
    }

    .closing-soon-item {
        border-radius: 8px;
        background: #fff;
        border: 1px solid #e2e8f0;
        transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .closing-soon-link {
        display: block;
        padding: 8px 10px;
        text-decoration: none;
        color: inherit;
    }

    .closing-soon-item:hover {
        background: #f1f5f9;
        border-color: #cbd5f5;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
    }

    .closing-soon-name {
        font-size: 13px;
        font-weight: 600;
        color: #0f172a;
        margin: 0 0 4px 0;
        line-height: 1.4;
    }

    .closing-soon-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 4px 8px;
        font-size: 11px;
        color: #64748b;
    }

    .closing-soon-deadline {
        color: #b91c1c;
        font-weight: 600;
    }

    .closing-soon-location {
        color: #64748b;
    }

    .closing-soon-empty {
        margin-top: 8px;
        font-size: 12px;
        color: #94a3b8;
    }

    /* 모바일에서는 우측 사이드바 숨김 + 단일 컬럼 */
    @media (max-width: 768px) {
        .contest-grid {
            grid-template-columns: 1fr;
        }

        .contest-grid-sidebar {
            display: none;
        }
    }

    /* 모바일에서 클릭 가능하도록 보장 */
    @media (max-width: 1024px) {
        /* body와 main은 항상 클릭 가능 */
        body {
            pointer-events: auto !important;
        }

        main {
            pointer-events: auto !important;
            position: relative !important;
            z-index: 1 !important;
        }

        /* 모든 섹션과 컨테이너도 클릭 가능하게 */
        section,
        .section,
        .container,
        .community-tabs,
        .contest-tab-btn,
        .contest-post-item,
        .contest-panel-list {
            pointer-events: auto !important;
            position: relative !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<section class="section" aria-labelledby="contest-title">
    <div class="container" style="margin-top: 0;">
        <!-- 배너 영역 (탭 위에 위치) -->
        {% if banner_images %}
        <div class="banner-wrapper" style="margin-top: 24px; margin-bottom: 24px;">
            <div class="badmintok-banners" aria-label="배드민톡 배너" data-banner-container>
                {% for banner in banner_images %}
                    <div class="badmintok-banner-item">
                        <span class="banner-sponsored-label">Sponsored</span>
                        {% if banner.link_url %}
                            <a href="{{ banner.link_url }}" target="_blank" rel="nofollow noopener noreferrer" style="display: block; width: 100%; height: 100%;">
                                <img src="{{ banner.url }}" alt="{{ banner.alt }}" loading="lazy" style="cursor: pointer;">
                            </a>
                        {% else %}
                            <img src="{{ banner.url }}" alt="{{ banner.alt }}" loading="lazy">
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <button class="banner-nav banner-nav-prev" data-banner-prev aria-label="이전 배너">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <button class="banner-nav banner-nav-next" data-banner-next aria-label="다음 배너">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
        </div>
        {% endif %}

        <!-- 카테고리 필터 탭 -->
        <div class="community-tabs" style="margin-bottom: 24px; border-bottom: 1px solid #e2e8f0; padding-bottom: 0;">
            <button class="community-tab contest-tab-btn active" role="tab" aria-selected="true" data-target="all">
                전체
            </button>
            {% for category in categories %}
                <button class="community-tab contest-tab-btn" role="tab" aria-selected="false" data-target="category-{{ category.id }}">
                    <span class="category-color-dot" style="background-color: {{ category.color }};"></span>
                    {{ category.name }}
                </button>
            {% endfor %}
        </div>
        <!-- 웹 캘린더 섹션 -->
        <div class="calendar-section desktop-only">
            <div class="contest-panels-calendar">
                <div class="contest-panel-calendar active" id="contest-panel-calendar-all" role="tabpanel">
                    <div class="calendar-controls">
                        <button type="button" class="calendar-nav-btn calendar-prev-btn" id="calendarPrevBtn" aria-label="이전 달">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <span class="calendar-title" id="calendarTitle">2025년 1월</span>
                        <button type="button" class="calendar-nav-btn calendar-next-btn" id="calendarNextBtn" aria-label="다음 달">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <!-- 숨겨진 select (JavaScript에서 사용) -->
                        <select class="calendar-select" id="calendarYear" aria-label="년도 선택" style="display: none;">
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                        </select>
                        <select class="calendar-select" id="calendarMonth" aria-label="월 선택" style="display: none;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                    </div>
                    <div class="calendar" id="calendarContainer">
                        <table aria-live="polite">
                            <thead>
                                <tr>
                                    <th scope="col">월</th>
                                    <th scope="col">화</th>
                                    <th scope="col">수</th>
                                    <th scope="col">목</th>
                                    <th scope="col">금</th>
                                    <th scope="col">토</th>
                                    <th scope="col">일</th>
                                </tr>
                            </thead>
                            <tbody id="calendarGrid"></tbody>
                        </table>
                    </div>
                </div>
                {% for category in categories %}
                <div class="contest-panel-calendar" id="contest-panel-calendar-category-{{ category.id }}" role="tabpanel">
                    <div class="calendar-controls">
                        <button type="button" class="calendar-nav-btn calendar-prev-btn" id="calendarPrevBtn-category-{{ category.id }}" aria-label="이전 달">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <span class="calendar-title" id="calendarTitle-category-{{ category.id }}">2025년 1월</span>
                        <button type="button" class="calendar-nav-btn calendar-next-btn" id="calendarNextBtn-category-{{ category.id }}" aria-label="다음 달">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <!-- 숨겨진 select (JavaScript에서 사용) -->
                        <select class="calendar-select" id="calendarYear-category-{{ category.id }}" aria-label="년도 선택" style="display: none;">
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                        </select>
                        <select class="calendar-select" id="calendarMonth-category-{{ category.id }}" aria-label="월 선택" style="display: none;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                    </div>
                    <div class="calendar" id="calendarContainer-category-{{ category.id }}">
                        <table aria-live="polite">
                            <thead>
                                <tr>
                                    <th scope="col">월</th>
                                    <th scope="col">화</th>
                                    <th scope="col">수</th>
                                    <th scope="col">목</th>
                                    <th scope="col">금</th>
                                    <th scope="col">토</th>
                                    <th scope="col">일</th>
                                </tr>
                            </thead>
                            <tbody id="calendarGrid-category-{{ category.id }}"></tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- 모바일 주간 캘린더 섹션 -->
        <div class="weekly-calendar-section mobile-only">
            <div class="weekly-calendar-controls">
                <button type="button" class="weekly-calendar-nav-btn" id="weeklyCalendarPrevBtn" aria-label="이전 달">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <span class="weekly-calendar-title" id="weeklyCalendarTitle">2025년 12월</span>
                <button type="button" class="weekly-calendar-nav-btn" id="weeklyCalendarNextBtn" aria-label="다음 달">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            <div class="weekly-calendar" id="weeklyCalendar">
                <div class="weekly-calendar-slide" id="weeklyCalendarSlide">
                    <!-- 주 단위 블록들이 여기에 동적으로 생성됩니다 -->
                </div>
            </div>
        </div>

        <!-- 검색 및 필터 섹션 -->
        <div style="margin: 40px 0 24px 0;">
            <!-- 필터 버튼들 (가로 배치) -->
            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                <button type="button" onclick="openFilterSheet('qualifying')" style="flex: 1; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; color: #1e293b; cursor: pointer; transition: all 0.2s;">
                    승급 여부
                </button>
                <button type="button" onclick="openFilterSheet('sponsor')" style="flex: 1; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; color: #1e293b; cursor: pointer; transition: all 0.2s;">
                    스폰서
                </button>
                <button type="button" onclick="openFilterSheet('region')" style="flex: 1; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; color: #1e293b; cursor: pointer; transition: all 0.2s;">
                    지역
                </button>
            </div>

            <!-- 검색창 -->
            <form method="get" action="{% url 'contests:list' %}" style="position: relative;">
                <!-- 필터 파라미터 유지 -->
                {% for value in request.GET.getlist.qualifying %}
                    <input type="hidden" name="qualifying" value="{{ value }}">
                {% endfor %}
                {% for value in request.GET.getlist.sponsor %}
                    <input type="hidden" name="sponsor" value="{{ value }}">
                {% endfor %}
                {% for value in request.GET.getlist.region %}
                    <input type="hidden" name="region" value="{{ value }}">
                {% endfor %}

                <input type="text"
                       name="search"
                       value="{{ request.GET.search }}"
                       placeholder="대회 검색"
                       style="width: 100%; padding: 12px 48px 12px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; box-sizing: border-box; font-family: inherit; background: #fff;">
                <button type="submit" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; background: var(--brand); border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
            </form>
        </div>

        <!-- 오버레이 -->
        <div id="filterOverlay" onclick="closeFilterSheet()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; transition: opacity 0.3s;"></div>

        <!-- 승급 여부 바텀시트 -->
        <div id="qualifyingSheet" class="filter-bottom-sheet" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-radius: 16px 16px 0 0; z-index: 1000; max-height: 70vh; transform: translateY(100%); transition: transform 0.3s;">
            <div style="padding: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                    <h3 style="font-size: 18px; font-weight: 700; color: #1e293b; margin: 0;">승급 여부</h3>
                    <button type="button" onclick="closeFilterSheet()" style="width: 32px; height: 32px; border: none; background: #f1f5f9; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 5L5 15M5 5L15 15" stroke="#64748b" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
                <form method="get" action="{% url 'contests:list' %}">
                    {% if request.GET.search %}
                        <input type="hidden" name="search" value="{{ request.GET.search }}">
                    {% endif %}
                    {% for value in request.GET.getlist.sponsor %}
                        <input type="hidden" name="sponsor" value="{{ value }}">
                    {% endfor %}
                    {% for value in request.GET.getlist.region %}
                        <input type="hidden" name="region" value="{{ value }}">
                    {% endfor %}

                    <div style="display: flex; gap: 16px; margin-bottom: 24px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" name="qualifying" value="true" {% if 'true' in request.GET.getlist.qualifying %}checked{% endif %} style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-size: 15px; color: #475569;">승급</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" name="qualifying" value="false" {% if 'false' in request.GET.getlist.qualifying %}checked{% endif %} style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-size: 15px; color: #475569;">비승급</span>
                        </label>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button type="submit" style="flex: 1; padding: 14px; background: var(--brand); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                            적용
                        </button>
                        <button type="button" onclick="window.location.href='{% url 'contests:list' %}?search={{ request.GET.search }}&sponsor={{ request.GET.getlist.sponsor|join:'&sponsor=' }}&region={{ request.GET.getlist.region|join:'&region=' }}'" style="padding: 14px 24px; background: #f1f5f9; color: #64748b; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                            초기화
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 스폰서 바텀시트 -->
        <div id="sponsorSheet" class="filter-bottom-sheet" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-radius: 16px 16px 0 0; z-index: 1000; max-height: 70vh; transform: translateY(100%); transition: transform 0.3s; overflow-y: auto;">
            <div style="padding: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                    <h3 style="font-size: 18px; font-weight: 700; color: #1e293b; margin: 0;">스폰서</h3>
                    <button type="button" onclick="closeFilterSheet()" style="width: 32px; height: 32px; border: none; background: #f1f5f9; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 5L5 15M5 5L15 15" stroke="#64748b" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
                <form method="get" action="{% url 'contests:list' %}">
                    {% if request.GET.search %}
                        <input type="hidden" name="search" value="{{ request.GET.search }}">
                    {% endif %}
                    {% for value in request.GET.getlist.qualifying %}
                        <input type="hidden" name="qualifying" value="{{ value }}">
                    {% endfor %}
                    {% for value in request.GET.getlist.region %}
                        <input type="hidden" name="region" value="{{ value }}">
                    {% endfor %}

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px;">
                        {% for sponsor in sponsors %}
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px;">
                                <input type="checkbox" name="sponsor" value="{{ sponsor.id }}" {% if sponsor.id|stringformat:"s" in request.GET.getlist.sponsor %}checked{% endif %} style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 15px; color: #475569;">{{ sponsor.name }}</span>
                            </label>
                        {% endfor %}
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button type="submit" style="flex: 1; padding: 14px; background: var(--brand); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                            적용
                        </button>
                        <button type="button" onclick="window.location.href='{% url 'contests:list' %}?search={{ request.GET.search }}&qualifying={{ request.GET.getlist.qualifying|join:'&qualifying=' }}&region={{ request.GET.getlist.region|join:'&region=' }}'" style="padding: 14px 24px; background: #f1f5f9; color: #64748b; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                            초기화
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 지역 바텀시트 -->
        <div id="regionSheet" class="filter-bottom-sheet" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-radius: 16px 16px 0 0; z-index: 1000; max-height: 70vh; transform: translateY(100%); transition: transform 0.3s; overflow-y: auto;">
            <div style="padding: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                    <h3 style="font-size: 18px; font-weight: 700; color: #1e293b; margin: 0;">지역</h3>
                    <button type="button" onclick="closeFilterSheet()" style="width: 32px; height: 32px; border: none; background: #f1f5f9; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 5L5 15M5 5L15 15" stroke="#64748b" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
                <form method="get" action="{% url 'contests:list' %}">
                    {% if request.GET.search %}
                        <input type="hidden" name="search" value="{{ request.GET.search }}">
                    {% endif %}
                    {% for value in request.GET.getlist.qualifying %}
                        <input type="hidden" name="qualifying" value="{{ value }}">
                    {% endfor %}
                    {% for value in request.GET.getlist.sponsor %}
                        <input type="hidden" name="sponsor" value="{{ value }}">
                    {% endfor %}

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px;">
                        {% for region_code, region_name in regions %}
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px;">
                                <input type="checkbox" name="region" value="{{ region_code }}" {% if region_code in request.GET.getlist.region %}checked{% endif %} style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 15px; color: #475569;">{{ region_name }}</span>
                            </label>
                        {% endfor %}
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button type="submit" style="flex: 1; padding: 14px; background: var(--brand); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                            적용
                        </button>
                        <button type="button" onclick="window.location.href='{% url 'contests:list' %}?search={{ request.GET.search }}&qualifying={{ request.GET.getlist.qualifying|join:'&qualifying=' }}&sponsor={{ request.GET.getlist.sponsor|join:'&sponsor=' }}'" style="padding: 14px 24px; background: #f1f5f9; color: #64748b; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                            초기화
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 대회 목록 + 우측 사이드바 그리드 -->
        <div class="contest-grid">
            <!-- 좌측: 대회 목록 섹션 (7) -->
            <div class="contest-list-section">
                <div class="contest-panels-list">
                    <div class="contest-panel-list active" id="contest-panel-list-all" role="tabpanel">
                        <div class="contest-list">
                            {% if contests %}
                                <div class="contest-post-list">
                                    {% for contest in contests %}
                                        <a href="{% url 'contests:detail' contest.slug %}" class="contest-post-item" data-schedule-start="{{ contest.schedule_start|date:'Y-m-d' }}" data-schedule-end="{% if contest.schedule_end %}{{ contest.schedule_end|date:'Y-m-d' }}{% else %}{{ contest.schedule_start|date:'Y-m-d' }}{% endif %}">
                                            <div class="contest-post-image">
                                                {% with first_image=contest.images.first %}
                                                    {% if first_image %}
                                                        <img src="{{ first_image.image.url }}" alt="{{ contest.title }}" class="contest-post-thumbnail">
                                                    {% else %}
                                                        <div class="contest-post-no-image">이미지 없음</div>
                                                    {% endif %}
                                                {% endwith %}
                                            </div>
                                            <div class="contest-post-content">
                                                <div class="contest-post-header">
                                                    {% with d_day=contest.get_d_day %}
                                                        {% if d_day is not None %}
                                                            {% if d_day < 0 %}
                                                                <span class="d-day-badge d-day-ended">종료</span>
                                                            {% elif d_day == 0 %}
                                                                <span class="d-day-badge d-day-today">D-Day</span>
                                                            {% elif d_day <= 3 %}
                                                                <span class="d-day-badge d-day-urgent">D-{{ d_day }}</span>
                                                            {% else %}
                                                                <span class="d-day-badge d-day-normal">D-{{ d_day }}</span>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endwith %}
                                                    {% if contest.category %}
                                                        <span class="contest-post-category" style="--badge-color: {{ contest.category.color }}">{{ contest.category.name }}</span>
                                                    {% endif %}
                                                    {% if contest.is_qualifying %}
                                                        <span class="contest-post-category contest-post-category-qualifying">승급</span>
                                                    {% else %}
                                                        <span class="contest-post-category contest-post-category-non-qualifying">비승급</span>
                                                    {% endif %}
                                                </div>
                                                <h3 class="contest-post-title">{{ contest.title }}</h3>
                                                {% if contest.sponsor %}
                                                <div class="contest-post-sponsor">
                                                    <span style="color: #64748b;">스폰서:</span>
                                                    <span style="margin-left: 8px; color: #1e293b; font-weight: 500;">{{ contest.sponsor.name }}</span>
                                                </div>
                                                {% endif %}
                                                <div class="contest-post-meta">
                                                    <div class="contest-post-info">
                                                        <span style="color: #64748b;">일정:</span>
                                                        <span style="margin-left: 8px;">{{ contest.get_period_display|default:'-' }}</span>
                                                    </div>
                                                    <div class="contest-post-info">
                                                        <span style="color: #64748b;">장소:</span>
                                                        <span style="margin-left: 8px;">{{ contest.get_location_display|default:"-"|bold_region }}</span>
                                                    </div>
                                                    <div class="contest-post-info">
                                                        <span style="color: #64748b;">접수 마감:</span>
                                                        <span style="margin-left: 8px;">{{ contest.registration_end|date:"Y.m.d"|default:'-' }}</span>
                                                    </div>
                                                </div>
                                            <div class="contest-post-stats">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                                </svg>
                                                <span>{{ contest.view_count }}</span>
                                            </div>
                                            </div>
                                        </a>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div style="padding: 48px; text-align: center; color: #64748b;">
                                    <p>등록된 대회 정보가 없습니다.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% for category in categories %}
                    <div class="contest-panel-list" id="contest-panel-list-category-{{ category.id }}" role="tabpanel">
                        <div class="contest-list">
                            <div class="contest-post-list" data-category-id="{{ category.id }}">
                                {% for contest in contests %}
                                    {% if contest.category and contest.category.id == category.id %}
                                    <a href="{% url 'contests:detail' contest.slug %}" class="contest-post-item" data-schedule-start="{{ contest.schedule_start|date:'Y-m-d' }}" data-schedule-end="{% if contest.schedule_end %}{{ contest.schedule_end|date:'Y-m-d' }}{% else %}{{ contest.schedule_start|date:'Y-m-d' }}{% endif %}">
                                        <div class="contest-post-image">
                                            {% with first_image=contest.images.first %}
                                                {% if first_image %}
                                                    <img src="{{ first_image.image.url }}" alt="{{ contest.title }}" class="contest-post-thumbnail">
                                                {% else %}
                                                    <div class="contest-post-no-image">이미지 없음</div>
                                                {% endif %}
                                            {% endwith %}
                                        </div>
                                        <div class="contest-post-content">
                                            <div class="contest-post-header">
                                                {% with d_day=contest.get_d_day %}
                                                    {% if d_day is not None %}
                                                        {% if d_day < 0 %}
                                                            <span class="d-day-badge d-day-ended">종료</span>
                                                        {% elif d_day == 0 %}
                                                            <span class="d-day-badge d-day-today">D-Day</span>
                                                        {% elif d_day <= 3 %}
                                                            <span class="d-day-badge d-day-urgent">D-{{ d_day }}</span>
                                                        {% else %}
                                                            <span class="d-day-badge d-day-normal">D-{{ d_day }}</span>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endwith %}
                                                    {% if contest.category %}
                                                <span class="contest-post-category" style="--badge-color: {{ contest.category.color }}">{{ contest.category.name }}</span>
                                                    {% endif %}
                                                {% if contest.is_qualifying %}
                                                    <span class="contest-post-category contest-post-category-qualifying">승급</span>
                                                {% else %}
                                                    <span class="contest-post-category contest-post-category-non-qualifying">비승급</span>
                                                {% endif %}
                                            </div>
                                            <h3 class="contest-post-title">{{ contest.title }}</h3>
                                            {% if contest.sponsor %}
                                            <div class="contest-post-sponsor">
                                                <span style="color: #64748b;">스폰서:</span>
                                                <span style="margin-left: 8px; color: #1e293b; font-weight: 500;">{{ contest.sponsor.name }}</span>
                                            </div>
                                            {% endif %}
                                            <div class="contest-post-meta">
                                                <div class="contest-post-info">
                                                    <span style="color: #64748b;">일정:</span>
                                                    <span style="margin-left: 8px;">{{ contest.get_period_display|default:'-' }}</span>
                                                </div>
                                                <div class="contest-post-info">
                                                    <span style="color: #64748b;">장소:</span>
                                                        <span style="margin-left: 8px;">{{ contest.get_location_display|default:"-"|bold_region }}</span>
                                                </div>
                                                <div class="contest-post-info">
                                                    <span style="color: #64748b;">접수 마감:</span>
                                                    <span style="margin-left: 8px;">{{ contest.registration_end|date:"Y.m.d"|default:'-' }}</span>
                                                </div>
                                            </div>
                                            <div class="contest-post-stats">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                                </svg>
                                                <span>{{ contest.view_count }}</span>
                                            </div>
                                        </div>
                                    </a>
                                    {% endif %}
                                {% empty %}
                                    <div style="padding: 48px; text-align: center; color: #64748b;">
                                        <p>해당 카테고리의 대회 정보가 없습니다.</p>
                                    </div>
                                {% endfor %}
                            </div>
                            {% comment %} 카테고리에 해당하는 대회가 없는 경우 빈 메시지 표시 (JavaScript에서 처리) {% endcomment %}
                            <div class="empty-message" style="padding: 48px; text-align: center; color: #64748b; display: none;">
                                <p>해당 카테고리의 대회 정보가 없습니다.</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- 우측: 사이드바 (3) -->
            <aside class="contest-grid-sidebar">
                <div class="closing-soon-box">
                    <h3 class="closing-soon-title">곧 접수가 마감돼요</h3>
                    <p class="closing-soon-subtitle">접수 마감까지 5일 이하 남은 대회</p>

                    {% if closing_soon_contests %}
                        <ul class="closing-soon-list">
                            {% for contest in closing_soon_contests %}
                                <li class="closing-soon-item">
                                    <a href="{% url 'contests:detail' contest.slug %}" class="closing-soon-link">
                                        <div class="closing-soon-name">{{ contest.title }}</div>
                                        <div class="closing-soon-meta">
                                            {% if contest.registration_end %}
                                                <span class="closing-soon-deadline">
                                                    접수 마감 {{ contest.registration_end|date:"Y.m.d" }}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="closing-soon-empty">
                            현재 5일 이내에 접수가 마감되는 대회가 없습니다.
                        </div>
                    {% endif %}
                </div>
            </aside>
        </div>
</section>

<style>
    /* 배너 스타일 */
    .banner-wrapper {
        position: relative;
        margin-top: 24px;
        margin-bottom: 24px;
    }

    .badmintok-banners {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        scroll-behavior: smooth;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE/Edge */
    }

    .badmintok-banners::-webkit-scrollbar {
        display: none; /* Chrome/Safari/Opera */
    }

    .badmintok-banner-item {
        position: relative;
        min-width: 100%;
        max-width: 100%;
        aspect-ratio: 8 / 3;
        scroll-snap-align: center;
        border-radius: 12px;
        overflow: hidden;
        background: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .badmintok-banner-item img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
        display: block;
        margin: 0 auto;
    }

    .banner-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
        z-index: 10;
    }

    .banner-nav:hover {
        background: rgba(0, 0, 0, 0.7);
    }

    .banner-nav:active {
        transform: translateY(-50%) scale(0.95);
    }

    .banner-nav-prev {
        left: 8px;
    }

    .banner-nav-next {
        right: 8px;
    }

    /* 캘린더 네비게이션 버튼 스타일 */
    .calendar-nav-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #ffffff;
        flex-shrink: 0;
    }

    .calendar-nav-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .calendar-nav-btn:active {
        transform: scale(0.95);
    }

    .calendar-nav-btn svg {
        display: block;
    }

    /* 대회 리스트 스타일 (커뮤니티 포스트 아이템과 동일) */
    .contest-post-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .contest-post-list:empty {
        display: none;
    }

    .contest-post-item {
        display: flex;
        gap: 20px;
        padding: 20px;
        background: #fff;
        border: none;
        border-bottom: 1px solid #e2e8f0;
        border-radius: 0;
        text-decoration: none;
        transition: all 0.2s ease;
        align-items: stretch;
        cursor: pointer;
        pointer-events: auto;
        touch-action: manipulation;
        overflow: hidden;
    }

    .contest-post-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .contest-post-item:active {
        transform: scale(0.98);
    }

    .contest-post-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 3px;
        min-width: 0;
        justify-content: flex-start;
    }

    .contest-post-header {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
        margin-bottom: 0;
    }

    /* D-day 뱃지 스타일 */
    .d-day-badge {
        display: inline-block;
        padding: 6px 12px;
        color: white;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .d-day-ended {
        background: #94a3b8;
    }

    .d-day-today {
        background: #ef4444;
    }

    .d-day-urgent {
        background: #f59e0b;
    }

    .d-day-normal {
        background: #3b82f6;
    }

    .contest-post-category {
        display: inline-block;
        padding: 6px 12px;
        background: var(--badge-color, var(--brand));
        color: #ffffff;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
    }

    .contest-post-category-qualifying {
        background: #3b82f6 !important;
        color: #ffffff;
    }

    .contest-post-category-non-qualifying {
        background: #64748b !important;
        color: #ffffff;
    }

    .contest-post-title {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: #1e293b;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .contest-post-sponsor {
        margin: 0;
        font-size: 14px;
        line-height: 1.5;
    }

    .contest-post-meta {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 14px;
        color: #1e293b;
        margin: 0;
    }

    .contest-post-info {
        font-size: 14px;
        color: #1e293b;
        line-height: 1.5;
    }

    .contest-post-stats {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #64748b;
        margin-top: 6px;
    }

    .contest-post-stats svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
    }

    .contest-post-image {
        width: 120px;
        height: auto;
        min-height: 160px;
        min-width: 120px;
        border-radius: 8px;
        overflow: hidden;
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        flex-shrink: 0;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .contest-post-thumbnail {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center center;
        display: block;
    }

    .contest-post-no-image {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        font-size: 12px;
        background: #f8fafc;
    }

    .contest-tab-btn {
        display: inline-flex;
        align-items: center;
        padding: 12px 20px;
        text-decoration: none;
        color: #64748b;
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: inherit;
        font-family: inherit;
        border-radius: 0;
    }

    .contest-tab-btn:hover {
        border-bottom-color: var(--brand);
    }

    .contest-tab-btn.active {
        color: var(--brand) !important;
        border-bottom: 2px solid var(--brand) !important;
        font-weight: 600;
    }

    /* 카테고리 색상 원 */
    .category-color-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
        flex-shrink: 0;
    }

    /* 모바일에서 카테고리 색상 원 크기 조정 */
    @media (max-width: 768px) {
        .category-color-dot {
            width: 12px;
            height: 12px;
            margin-right: 6px;
        }
    }

    /* 캘린더 섹션과 리스트 섹션 분리 */
    .calendar-section {
        margin-bottom: 48px;
    }

    .contest-list-section {
    }

    .contest-panels-calendar .contest-panel-calendar,
    .contest-panels-list .contest-panel-list {
        display: none;
    }

    .contest-panels-calendar .contest-panel-calendar.active,
    .contest-panels-list .contest-panel-list.active {
        display: block;
    }

    /* 기본적으로 모바일 전용 요소는 숨김 */
    .mobile-only {
        display: none;
    }

    /* 기본적으로 데스크톱 전용 요소는 표시 */
    .desktop-only {
        display: block;
    }

    .contest-list {
        width: 100%;
    }

    /* 데스크톱에서 웹 캘린더 강제 표시 */
    @media (min-width: 769px) {
        .desktop-only,
        .calendar-section {
            display: block !important;
            visibility: visible !important;
        }

        .calendar,
        .calendar-banner-layer,
        .calendar-event-banner {
            display: block !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }

        /* 패널은 active 클래스가 있을 때만 표시 */
        .contest-panels-calendar .contest-panel-calendar.active {
            display: block !important;
            visibility: visible !important;
        }

        .mobile-only {
            display: none !important;
        }
    }

    /* 모바일/태블릿 레이아웃 */
    @media (max-width: 1024px) {
        .mobile-only {
            display: block !important;
        }

        .desktop-only {
            display: none !important;
        }

        .contest-list {
            display: block;
            width: 100%;
        }

        .contest-post-list {
            display: flex !important;
            flex-direction: column !important;
            gap: 16px !important;
        }

        /* 모바일에서 패널 표시 규칙 */
        .contest-panels-list .contest-panel-list {
            display: none !important;
        }

        .contest-panels-list .contest-panel-list.active {
            display: block !important;
        }

        /* 모바일 대회 포스트 레이아웃 최적화 */
        .contest-post-item {
            gap: 16px;
            padding: 16px;
        }

        .contest-post-image {
            width: 110px;
            height: auto;
            min-height: 140px;
            min-width: 110px;
        }

        .contest-post-content {
            gap: 3px;
        }

        .contest-post-header {
            gap: 5px;
        }

        .d-day-badge,
        .contest-post-category {
            padding: 4px 10px;
            font-size: 12px;
        }

        .contest-post-title {
            font-size: 16px;
            line-height: 1.4;
            -webkit-line-clamp: 2;
        }

        .contest-post-sponsor {
            font-size: 13px;
            line-height: 1.5;
        }

        .contest-post-meta {
            gap: 4px;
            font-size: 13px;
        }

        .contest-post-info {
            font-size: 13px;
            line-height: 1.5;
        }

        /* 탭 버튼 스크롤 가능하게 */
        .community-tabs {
            display: flex !important;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
            white-space: nowrap;
        }

        .community-tabs::-webkit-scrollbar {
            display: none; /* Chrome/Safari/Opera */
        }

        .contest-tab-btn {
            white-space: nowrap;
            flex-shrink: 0;
        }

        .contest-list-section {
            margin-top: 0;
        }
    }

    /* 주간 캘린더 스타일 - 모든 모바일/태블릿에서 표시 */
    @media (max-width: 1024px) {
        .weekly-calendar-section {
            display: block !important;
            margin-bottom: 32px;
        }

        .weekly-calendar-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--brand);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .weekly-calendar-nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .weekly-calendar-nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .weekly-calendar-title {
            color: white;
            font-size: 18px;
            font-weight: 700;
        }

        .weekly-calendar {
            position: relative;
            overflow: hidden;
            width: 100%;
            transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .weekly-calendar-slide {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
            top: 0;
            left: 0;
            will-change: transform;
        }

        .weekly-calendar-slide:only-child {
            position: relative;
        }

        /* 주 블록 */
        .weekly-block {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        /* 주 헤더 */
        .weekly-header {
            background: #f8fafc;
            color: #334155;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            border-bottom: 1px solid #e2e8f0;
        }

        /* 대회 리스트 */
        .weekly-contest-list {
            padding: 0;
        }

        /* 대회 아이템 */
        .weekly-contest-item {
            display: block;
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }

        .weekly-contest-item:last-child {
            border-bottom: none;
        }

        .weekly-contest-item:hover {
            background: #f8fafc;
        }

        .weekly-contest-item:active {
            background: #f1f5f9;
            transform: scale(0.99);
        }

        /* 대회 정보 배너 (날짜 + 제목) */
        .weekly-contest-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .weekly-contest-info-date {
            font-size: 11px;
            opacity: 0.85;
            font-weight: 500;
        }

        .weekly-contest-info-title {
            font-size: 15px;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    }

    /* 아주 작은 모바일 화면 */
    @media (max-width: 480px) {
        .contest-post-item {
            padding: 12px;
            gap: 12px;
        }

        .contest-post-image {
            width: 95px;
            height: auto;
            min-height: 120px;
            min-width: 95px;
        }

        .contest-post-content {
            gap: 3px;
        }

        .d-day-badge,
        .contest-post-category {
            padding: 3px 8px;
            font-size: 11px;
        }

        .contest-post-title {
            font-size: 15px;
            line-height: 1.4;
        }

        .contest-post-header {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .contest-post-sponsor {
            font-size: 12px;
            line-height: 1.5;
        }

        .contest-post-meta {
            gap: 4px;
        }

        .contest-post-info {
            font-size: 12px;
            line-height: 1.5;
        }

        .contest-tab-btn {
            padding: 10px 14px;
            font-size: 14px;
        }
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    'use strict';

    // 전역 에러 핸들러 - Promise 오류 처리
    window.addEventListener('unhandledrejection', function(event) {
        // 외부 스크립트 오류는 무시
        if (event.reason && typeof event.reason === 'string' &&
            (event.reason.includes('contents.js') ||
             event.reason.includes('main_pack') ||
             event.reason.includes('nx_right_related_keywords'))) {
            event.preventDefault();
            return;
        }
        // 우리 코드의 오류만 로깅
        console.error('Unhandled promise rejection:', event.reason);
    });

    // 전역 에러 핸들러 - 일반 오류 처리
    window.addEventListener('error', function(event) {
        // 외부 스크립트 오류는 무시
        if (event.filename && (
            event.filename.includes('contents.js') ||
            event.filename.includes('search-layer.ts') ||
            event.message.includes('main_pack') ||
            event.message.includes('nx_right_related_keywords')
        )) {
            event.preventDefault();
            return;
        }
    }, true);

    // 모바일 감지 함수
    function checkMobile() {
        return window.matchMedia("(max-width: 1024px)").matches;
    }
    let isMobile = checkMobile();

    // 전역 변수: 모든 대회 데이터 (모바일 핸들러에서도 접근 가능)
    let allContestData = [];

    // 전역 함수: 주간 캘린더 렌더링 (모바일 핸들러에서도 접근 가능)
    let renderWeeklyCalendar = null;

    // 모바일 전용 탭 핸들러
    let mobileTabsInitialized = false;
    let mobileTabHandler = null;

    function initMobileTabs() {
        const currentMobile = checkMobile();
        if (!currentMobile) {
            mobileTabsInitialized = false;
            // 모바일이 아니면 이벤트 제거
            if (mobileTabHandler) {
                const tabButtons = document.querySelectorAll(".contest-tab-btn");
                tabButtons.forEach(function(button) {
                    button.removeEventListener('click', mobileTabHandler);
                });
            }
            return;
        }
        if (mobileTabsInitialized) return;

        const tabButtons = document.querySelectorAll(".contest-tab-btn");
        if (!tabButtons.length) return;

        // 모바일 탭 클릭 핸들러
        mobileTabHandler = function(e) {
            if (!checkMobile()) return; // 모바일인지 다시 확인

            // 다른 핸들러 실행 방지
            e.stopImmediatePropagation();

            const target = this.getAttribute('data-target');
            if (!target) return;

            console.log('[Mobile] Tab clicked:', target);

            // 모든 탭 버튼 업데이트
            const allTabs = document.querySelectorAll(".contest-tab-btn");
            allTabs.forEach(function(btn) {
                const isActive = btn.getAttribute('data-target') === target;
                btn.classList.toggle("active", isActive);
                btn.setAttribute("aria-selected", isActive ? "true" : "false");
            });

            // 모바일에서 웹 캘린더 완전히 숨기기
            const calendarSection = document.querySelector('.calendar-section');
            if (calendarSection) {
                calendarSection.style.setProperty('display', 'none', 'important');
                console.log('[Mobile] Web calendar hidden');
            }

            // 리스트 패널 업데이트
            const listPanels = document.querySelectorAll(".contest-panel-list");
            listPanels.forEach(function(panel) {
                const panelTarget = panel.id.replace("contest-panel-list-", "");
                const isActive = panelTarget === target;
                panel.classList.toggle("active", isActive);

                // 실제 display 속성 확인
                const computedStyle = window.getComputedStyle(panel);
                const itemCount = panel.querySelectorAll('.contest-post-item').length;
                console.log('[Mobile] Panel:', panel.id,
                    'Active:', isActive,
                    'Display:', computedStyle.display,
                    'Items:', itemCount);
            });

            // 모바일 주말 캘린더 필터링 및 다시 렌더링
            const weeklyCalendarSection = document.querySelector('.weekly-calendar-section');
            if (weeklyCalendarSection) {
                weeklyCalendarSection.style.setProperty('display', 'block', 'important');

                // allContestData가 아직 로드되지 않았으면 스킵
                if (!allContestData || allContestData.length === 0) {
                    console.log('[Mobile] Warning: Contest data not loaded yet');
                    return;
                }

                // 현재 표시된 년/월 가져오기
                const titleElement = document.getElementById('weeklyCalendarTitle');
                if (titleElement) {
                    const titleText = titleElement.textContent; // "2025년 1월"
                    const matches = titleText.match(/(\d+)년\s*(\d+)월/);
                    if (matches) {
                        const year = parseInt(matches[1]);
                        const month = parseInt(matches[2]);

                        // 카테고리별로 필터링된 대회 가져오기
                        let filteredContests;
                        if (target === 'all') {
                            filteredContests = allContestData;
                        } else {
                            const categoryId = parseInt(target.replace('category-', ''));
                            filteredContests = allContestData.filter(contest =>
                                contest.category && contest.category.id === categoryId
                            );
                        }

                        // 해당 월의 대회만 필터링
                        const monthContests = filteredContests.filter((contest) => {
                            if (!contest.schedule_start) return false;
                            const startYear = contest.schedule_start.getFullYear();
                            const startMonth = contest.schedule_start.getMonth() + 1;
                            const endYear = contest.schedule_end ? contest.schedule_end.getFullYear() : startYear;
                            const endMonth = contest.schedule_end ? contest.schedule_end.getMonth() + 1 : startMonth;

                            if (startYear === year && startMonth === month) return true;
                            if (endYear === year && endMonth === month) return true;
                            if (startYear < year && endYear > year) return true;
                            if (startYear === year && endYear === year && startMonth < month && endMonth > month) return true;

                            return false;
                        });

                        // 주말 캘린더 다시 렌더링 (슬라이드 애니메이션 없이)
                        if (renderWeeklyCalendar) {
                            console.log('[Mobile] Filtering weekly calendar for:', target, 'Total:', filteredContests.length, 'This month:', monthContests.length);
                            renderWeeklyCalendar(year, month, monthContests, null);
                            console.log('[Mobile] Weekly calendar re-rendered');
                        } else {
                            console.log('[Mobile] ERROR: renderWeeklyCalendar not available');
                        }
                    }
                }
            }
        };

        // 이벤트 리스너 추가
        tabButtons.forEach(function(button) {
            button.addEventListener('click', mobileTabHandler);
        });

        mobileTabsInitialized = true;
        console.log('[Mobile] Tabs initialized');

        // 현재 활성화된 탭 찾아서 패널 상태 복원
        const activeTab = document.querySelector('.contest-tab-btn.active');
        if (activeTab) {
            const target = activeTab.getAttribute('data-target');
            console.log('[Mobile] Restoring active tab:', target);

            // 모바일에서 웹 캘린더 완전히 숨기기
            const calendarSection = document.querySelector('.calendar-section');
            if (calendarSection) {
                calendarSection.style.setProperty('display', 'none', 'important');
            }

            // 리스트 패널 업데이트
            const listPanels = document.querySelectorAll(".contest-panel-list");
            listPanels.forEach(function(panel) {
                const panelTarget = panel.id.replace("contest-panel-list-", "");
                const isActive = panelTarget === target;
                panel.classList.toggle("active", isActive);
            });

            // 주말 캘린더 필터링 및 다시 렌더링
            const weeklyCalendarSection = document.querySelector('.weekly-calendar-section');
            if (weeklyCalendarSection) {
                weeklyCalendarSection.style.setProperty('display', 'block', 'important');

                // allContestData가 아직 로드되지 않았으면 스킵
                if (!allContestData || allContestData.length === 0) {
                    console.log('[Mobile] Restore: Contest data not loaded yet');
                    return;
                }

                const titleElement = document.getElementById('weeklyCalendarTitle');
                if (titleElement) {
                    const titleText = titleElement.textContent;
                    const matches = titleText.match(/(\d+)년\s*(\d+)월/);
                    if (matches) {
                        const year = parseInt(matches[1]);
                        const month = parseInt(matches[2]);

                        let filteredContests;
                        if (target === 'all') {
                            filteredContests = allContestData;
                        } else {
                            const categoryId = parseInt(target.replace('category-', ''));
                            filteredContests = allContestData.filter(contest =>
                                contest.category && contest.category.id === categoryId
                            );
                        }

                        const monthContests = filteredContests.filter((contest) => {
                            if (!contest.schedule_start) return false;
                            const startYear = contest.schedule_start.getFullYear();
                            const startMonth = contest.schedule_start.getMonth() + 1;
                            const endYear = contest.schedule_end ? contest.schedule_end.getFullYear() : startYear;
                            const endMonth = contest.schedule_end ? contest.schedule_end.getMonth() + 1 : startMonth;

                            if (startYear === year && startMonth === month) return true;
                            if (endYear === year && endMonth === month) return true;
                            if (startYear < year && endYear > year) return true;
                            if (startYear === year && endYear === year && startMonth < month && endMonth > month) return true;

                            return false;
                        });

                        if (renderWeeklyCalendar) {
                            console.log('[Mobile] Restore: Filtering for', target, 'Contests:', monthContests.length);
                            renderWeeklyCalendar(year, month, monthContests, null);
                            console.log('[Mobile] Restore: Weekly calendar re-rendered');
                        } else {
                            console.log('[Mobile] Restore: ERROR - renderWeeklyCalendar not available');
                        }
                    }
                }
            }
        }
    }

    // 모바일에서 탭 초기화
    if (isMobile) {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initMobileTabs();
                // 초기 로드 시 웹 캘린더 강제 숨김
                const calendarSection = document.querySelector('.calendar-section');
                if (calendarSection) {
                    calendarSection.style.setProperty('display', 'none', 'important');
                    console.log('[Mobile] Initial: Web calendar hidden');
                }
            });
        } else {
            initMobileTabs();
            // 초기 로드 시 웹 캘린더 강제 숨김
            const calendarSection = document.querySelector('.calendar-section');
            if (calendarSection) {
                calendarSection.style.setProperty('display', 'none', 'important');
                console.log('[Mobile] Initial: Web calendar hidden');
            }
        }
    }

    // 데스크톱: 전체 기능 (항상 실행, CSS로 표시/숨김 제어)
    document.addEventListener("DOMContentLoaded", function () {
            const tabButtons = document.querySelectorAll(".contest-tab-btn");

            // 모든 대회 데이터 로드 및 준비
            const contestData = JSON.parse("{{ contest_data|default:'[]'|escapejs }}");

        const parseLocalDate = (value) => {
            if (!value) return null;
            const parts = value.split('-').map(Number);
            if (parts.length !== 3) return null;
            const [y, m, d] = parts;
            return new Date(y, m - 1, d);
        };

        // 전역 변수 allContestData에 값 할당
        allContestData = contestData
            .map((contest) => {
                const start = parseLocalDate(contest.schedule_start);
                const end = parseLocalDate(contest.schedule_end) || start;
                if (!start || !end || end < start) {
                    return null;
                }
                return {
                    ...contest,
                    schedule_start: start,
                    schedule_end: end,
                };
            })
            .filter(Boolean);

        console.log('[Init] Contest data loaded:', allContestData.length, 'contests');

        // 카테고리 ID로 필터링하는 함수
        function filterContestsByCategory(contests, categoryId) {
            if (!categoryId || categoryId === 'all') {
                return contests;
            }
            const categoryIdNum = parseInt(categoryId.replace('category-', ''), 10);
            return contests.filter((contest) => {
                return contest.category && contest.category.id === categoryIdNum;
            });
        }

        // 범용 달력 렌더링 함수 (주말 병합 버전)
        function renderCalendar(panelId, year, month, filteredContests) {
            const calendarTitle = panelId === 'all'
                ? document.getElementById("calendarTitle")
                : document.getElementById(`calendarTitle-${panelId}`);
            const calendarGrid = panelId === 'all'
                ? document.getElementById("calendarGrid")
                : document.getElementById(`calendarGrid-${panelId}`);

            if (!calendarTitle || !calendarGrid) {
                return;
            }

            const firstDay = new Date(year, month - 1, 1);
            const lastDate = new Date(year, month, 0).getDate();
            const startIndex = (firstDay.getDay() + 6) % 7; // 월요일 시작 (0=월, 5=토, 6=일)

            calendarTitle.textContent = `${year}년 ${month}월`;
            calendarGrid.innerHTML = "";

            // 날짜별 셀 정보 저장
            const dayToCellMap = new Map();

            let row = document.createElement("tr");
            let currentCol = 0;

            // 첫 주 빈 칸 추가
            for (let i = 0; i < startIndex; i++) {
                const emptyCell = document.createElement("td");
                emptyCell.className = "empty";
                row.appendChild(emptyCell);
                currentCol++;
            }

            // 날짜 셀 생성
            for (let day = 1; day <= lastDate; day++) {
                const dayOfWeek = (startIndex + day - 1) % 7; // 0=월, 5=토, 6=일
                const isSaturday = dayOfWeek === 5;
                const isSunday = dayOfWeek === 6;

                // 토요일이면 토-일 병합 셀 생성
                if (isSaturday && day < lastDate) {
                    const cell = document.createElement("td");
                    cell.classList.add("calendar-day-cell", "weekend-cell");
                    cell.setAttribute("colspan", "2");

                    const label = document.createElement("span");
                    label.className = "calendar-day-label";
                    label.textContent = `${day}~${day + 1}`;
                    cell.appendChild(label);

                    const content = document.createElement("div");
                    content.className = "calendar-day-content";
                    cell.appendChild(content);

                    row.appendChild(cell);

                    // 토요일과 일요일 모두 이 셀에 매핑
                    dayToCellMap.set(day, { cell, content, isMerged: true });
                    dayToCellMap.set(day + 1, { cell, content, isMerged: true });

                    currentCol += 2;

                    // 주 종료
                    calendarGrid.appendChild(row);
                    row = document.createElement("tr");
                    currentCol = 0;

                    // 일요일은 이미 처리했으므로 건너뛰기
                    day++;
                    continue;
                }

                // 일요일이 단독으로 남은 경우
                if (isSunday) {
                    const cell = document.createElement("td");
                    cell.classList.add("calendar-day-cell", "weekend-cell");

                    const label = document.createElement("span");
                    label.className = "calendar-day-label";
                    label.textContent = day;
                    cell.appendChild(label);

                    const content = document.createElement("div");
                    content.className = "calendar-day-content";
                    cell.appendChild(content);

                    row.appendChild(cell);
                    dayToCellMap.set(day, { cell, content, isMerged: false });

                    currentCol++;

                    // 주 종료
                    calendarGrid.appendChild(row);
                    row = document.createElement("tr");
                    currentCol = 0;
                    continue;
                }

                // 토요일이 단독으로 남은 경우 (마지막 날이 토요일인 경우)
                if (isSaturday && day === lastDate) {
                    const cell = document.createElement("td");
                    cell.classList.add("calendar-day-cell", "weekend-cell");

                    const label = document.createElement("span");
                    label.className = "calendar-day-label";
                    label.textContent = day;
                    cell.appendChild(label);

                    const content = document.createElement("div");
                    content.className = "calendar-day-content";
                    cell.appendChild(content);

                    row.appendChild(cell);
                    dayToCellMap.set(day, { cell, content, isMerged: false });

                    currentCol++;
                    continue;
                }

                // 평일 셀 생성
                const cell = document.createElement("td");
                cell.classList.add("calendar-day-cell");

                const label = document.createElement("span");
                label.className = "calendar-day-label";
                label.textContent = day;
                cell.appendChild(label);

                const content = document.createElement("div");
                content.className = "calendar-day-content";
                cell.appendChild(content);

                row.appendChild(cell);
                dayToCellMap.set(day, { cell, content, isMerged: false });

                currentCol++;
            }

            // 마지막 주 마무리
            if (currentCol > 0) {
                // 남은 빈 칸 추가
                while (currentCol < 7) {
                    const emptyCell = document.createElement("td");
                    emptyCell.className = "empty";
                    row.appendChild(emptyCell);
                    currentCol++;
                }
                calendarGrid.appendChild(row);
            }

            // 대회 배너를 해당 날짜 셀에 직접 삽입
            const normalizeCategoryName = (name) => {
                if (!name) return "";
                return name.replace(/\s+/g, "").toLowerCase();
            };

            const categoryPriorityMap = new Map([
                ["전국대회", 0],
                ["전국", 0],
                ["지역대회", 1],
                ["지역", 1],
                ["이벤트대회", 2],
                ["이벤트", 2],
                ["평일대회", 3],
                ["평일", 3],
            ]);

            const getCategoryPriority = (category) => {
                if (!category || !category.name) return 999;
                const normalized = normalizeCategoryName(category.name);
                return categoryPriorityMap.get(normalized) ?? 999;
            };

            const sortedContests = [...filteredContests].sort((a, b) => {
                const priorityA = getCategoryPriority(a.category);
                const priorityB = getCategoryPriority(b.category);
                if (priorityA !== priorityB) {
                    return priorityA - priorityB;
                }
                const timeA = a.schedule_start ? a.schedule_start.getTime() : 0;
                const timeB = b.schedule_start ? b.schedule_start.getTime() : 0;
                return timeA - timeB;
            });

            // 각 날짜별로 대회 배너 삽입
            sortedContests.forEach((contest) => {
                if (!contest.schedule_start) return;

                const startYear = contest.schedule_start.getFullYear();
                const startMonth = contest.schedule_start.getMonth() + 1;
                const startDay = contest.schedule_start.getDate();

                const endYear = contest.schedule_end ? contest.schedule_end.getFullYear() : startYear;
                const endMonth = contest.schedule_end ? contest.schedule_end.getMonth() + 1 : startMonth;
                const endDay = contest.schedule_end ? contest.schedule_end.getDate() : startDay;

                let displayDay = null;

                // 시작일이 현재 달력의 월에 속하면 시작일에 표시
                if (startYear === year && startMonth === month) {
                    displayDay = startDay;
                }
                // 시작일이 현재 월이 아니고 종료일이 현재 월에 속하면 종료일에 표시
                else if (endYear === year && endMonth === month) {
                    displayDay = endDay;
                }

                if (!displayDay) return;

                // 해당 날짜의 셀에 배너 추가
                const cellInfo = dayToCellMap.get(displayDay);
                if (!cellInfo) return;

                const color = contest.category && contest.category.color ? contest.category.color : "#31AA60";
                const banner = document.createElement("a");
                banner.className = "calendar-event-item";
                banner.href = `/badminton-tournament/${contest.slug}/`;
                banner.textContent = contest.title;
                banner.style.backgroundColor = color;
                banner.title = `${contest.title} (${contest.period_display || ""})`;

                cellInfo.content.appendChild(banner);
            });
        }

        // 주말 캘린더 렌더링 함수
        function renderWeekendCalendar(year, month, filteredContests) {
            const weekendCalendarTitle = document.getElementById("weekendCalendarTitle");
            const weekendCalendar = document.getElementById("weekendCalendar");

            if (!weekendCalendarTitle || !weekendCalendar) {
                return;
            }

            weekendCalendarTitle.textContent = `${year}년 ${month}월`;
            weekendCalendar.innerHTML = "";

            const firstDay = new Date(year, month - 1, 1);
            const lastDate = new Date(year, month, 0).getDate();
            const startDayOfWeek = (firstDay.getDay() + 6) % 7; // 0=월요일

            // 주차별로 날짜 그룹화
            const weeks = [];
            let currentWeek = [];

            for (let day = 1; day <= lastDate; day++) {
                const dayOfWeek = (startDayOfWeek + day - 1) % 7;
                currentWeek.push(day);

                // 일요일(6)이거나 마지막 날이면 주차 완료
                if (dayOfWeek === 6 || day === lastDate) {
                    weeks.push([...currentWeek]);
                    currentWeek = [];
                }
            }

            // 각 주차별로 블록 생성
            weeks.forEach((week, weekIndex) => {
                const weekBlock = document.createElement("div");
                weekBlock.className = "week-block";

                // 평일 (월~금) 표시
                const weekdays = [];
                const weekend = [];

                week.forEach(day => {
                    const dayOfWeek = (startDayOfWeek + day - 1) % 7;
                    if (dayOfWeek < 5) { // 월~금
                        weekdays.push(day);
                    } else { // 토~일
                        weekend.push(day);
                    }
                });

                // 평일 행 생성
                if (weekdays.length > 0) {
                    const weekdaysDiv = document.createElement("div");
                    weekdaysDiv.className = "weekdays";
                    weekdaysDiv.textContent = weekdays.join("  ");
                    weekBlock.appendChild(weekdaysDiv);
                }

                // 주말 행 생성
                if (weekend.length > 0) {
                    const weekendDaysDiv = document.createElement("div");
                    weekendDaysDiv.className = "weekend-days";

                    weekend.forEach((day, index) => {
                        const dayOfWeek = (startDayOfWeek + day - 1) % 7;
                        const dayName = dayOfWeek === 5 ? "토" : "일";

                        const weekendDayDiv = document.createElement("div");
                        weekendDayDiv.className = "weekend-day";

                        const label = document.createElement("span");
                        label.className = "weekend-day-label";
                        label.textContent = `${day} (${dayName})`;
                        weekendDayDiv.appendChild(label);

                        const content = document.createElement("div");
                        content.className = "weekend-day-content";

                        // 해당 날짜의 대회 찾기
                        filteredContests.forEach(contest => {
                            if (!contest.schedule_start) return;

                            const contestDay = contest.schedule_start.getDate();
                            const contestMonth = contest.schedule_start.getMonth() + 1;
                            const contestEndDay = contest.schedule_end ? contest.schedule_end.getDate() : contestDay;

                            // 해당 날짜에 시작하거나 포함되는 대회
                            if (contestMonth === month && contestDay <= day && day <= contestEndDay) {
                                const banner = document.createElement("a");
                                banner.className = "weekend-contest-banner";
                                banner.href = `/badminton-tournament/${contest.slug}/`;

                                // 카테고리 배지
                                if (contest.category) {
                                    const categoryBadge = document.createElement("span");
                                    categoryBadge.className = "category-badge";
                                    categoryBadge.style.setProperty("--badge-color", contest.category.color || "#31AA60");
                                    categoryBadge.textContent = contest.category.name;
                                    banner.appendChild(categoryBadge);
                                }

                                // 대회명
                                const titleText = document.createTextNode(contest.title);
                                banner.appendChild(titleText);

                                content.appendChild(banner);
                            }
                        });

                        weekendDayDiv.appendChild(content);
                        weekendDaysDiv.appendChild(weekendDayDiv);
                    });

                    weekBlock.appendChild(weekendDaysDiv);
                }

                weekendCalendar.appendChild(weekBlock);
            });
        }

        // 테이블 렌더링 함수
        function updateContestList(panelId, filteredContests) {
            if (panelId === 'all') {
                return;
            }

            const contestList = document.querySelector(`#contest-panel-list-${panelId} .contest-post-list`);
            const emptyMessage = document.querySelector(`#contest-panel-list-${panelId} .empty-message`);

            if (!contestList) {
                return;
            }

            // 카드 리스트에서 실제로 보이는 아이템 개수 확인
            const visibleItems = contestList.querySelectorAll('.contest-post-item:not([style*="display: none"])').length;
            const hasVisibleItems = visibleItems > 0 || contestList.querySelectorAll('.contest-post-item').length > 0;

            // 서버에서 이미 렌더링된 카드 리스트가 있으므로, 빈 메시지만 표시/숨김 처리
            if (!hasVisibleItems || filteredContests.length === 0) {
                if (emptyMessage) {
                    emptyMessage.style.display = 'block';
                }
                if (contestList) {
                    contestList.style.display = 'none';
                }
            } else {
                if (emptyMessage) {
                    emptyMessage.style.display = 'none';
                }
                if (contestList) {
                    contestList.style.display = 'flex';
                }
            }
        }

        // 패널 업데이트 함수
        function updatePanel(panelId, categoryId) {
            const calendarPanel = document.getElementById(`contest-panel-calendar-${panelId}`);
            const listPanel = document.getElementById(`contest-panel-list-${panelId}`);

            if ((!calendarPanel || !calendarPanel.classList.contains("active")) &&
                (!listPanel || !listPanel.classList.contains("active"))) {
                return;
            }

            const filteredContests = filterContestsByCategory(allContestData, categoryId);

            const yearSelect = panelId === 'all'
                ? document.getElementById("calendarYear")
                : document.getElementById(`calendarYear-${panelId}`);
            const monthSelect = panelId === 'all'
                ? document.getElementById("calendarMonth")
                : document.getElementById(`calendarMonth-${panelId}`);

            if (!yearSelect || !monthSelect) {
                return;
            }

            const year = parseInt(yearSelect.value, 10);
            const month = parseInt(monthSelect.value, 10);

            const monthContests = filteredContests.filter((contest) => {
                if (!contest.schedule_start) return false;

                const startYear = contest.schedule_start.getFullYear();
                const startMonth = contest.schedule_start.getMonth() + 1;
                const startDate = contest.schedule_start.getDate();

                const endYear = contest.schedule_end ? contest.schedule_end.getFullYear() : startYear;
                const endMonth = contest.schedule_end ? contest.schedule_end.getMonth() + 1 : startMonth;
                const endDate = contest.schedule_end ? contest.schedule_end.getDate() : startDate;

                // 시작일이 현재 월에 있는 경우
                if (startYear === year && startMonth === month) {
                    return true;
                }

                // 종료일이 현재 월에 있는 경우
                if (endYear === year && endMonth === month) {
                    return true;
                }

                // 대회가 현재 월을 포함하는 경우 (대회가 여러 달에 걸쳐 진행)
                const currentMonthStart = new Date(year, month - 1, 1);
                const currentMonthEnd = new Date(year, month, 0);
                if (contest.schedule_start <= currentMonthEnd && contest.schedule_end >= currentMonthStart) {
                    return true;
                }

                return false;
            });

            renderCalendar(panelId, year, month, monthContests);
            updateContestList(panelId, filteredContests);

            // 모바일 주말 캘린더 렌더링 (전체 탭만)
            if (isMobile && panelId === 'all') {
                renderWeekendCalendar(year, month, monthContests);
            }
        }

        // 탭 클릭 이벤트 처리 (데스크톱만)
        if (!isMobile) {
            tabButtons.forEach((button) => {
                button.addEventListener("click", function(e) {
                    // 모바일이면 이 핸들러 무시
                    if (checkMobile()) {
                        console.log('[Desktop] Handler blocked on mobile');
                        return;
                    }

                    const target = button.dataset.target;
                    if (!target) return;

                    console.log('[Desktop] Tab clicked:', target);

                    // 모든 탭 버튼 상태 업데이트
                    const allTabButtons = document.querySelectorAll(".contest-tab-btn");
                    allTabButtons.forEach((btn) => {
                        const isActive = btn === button;
                        btn.classList.toggle("active", isActive);
                        btn.setAttribute("aria-selected", isActive ? "true" : "false");
                    });

                    // 캘린더 패널 업데이트
                    const calendarPanels = document.querySelectorAll(".contest-panel-calendar");
                    calendarPanels.forEach((panel) => {
                        const isActive = panel.id === `contest-panel-calendar-${target}`;
                        panel.classList.toggle("active", isActive);
                    });

                    // 리스트 패널 업데이트
                    const listPanels = document.querySelectorAll(".contest-panel-list");
                    listPanels.forEach((panel) => {
                        const isActive = panel.id === `contest-panel-list-${target}`;
                        panel.classList.toggle("active", isActive);
                    });

                    // 패널 업데이트
                    setTimeout(() => {
                        updatePanel(target, target);
                    }, 10);
                }, { passive: true });
            });
        }

        // 전체 패널의 년/월 선택 이벤트
        const yearSelect = document.getElementById("calendarYear");
        const monthSelect = document.getElementById("calendarMonth");

        if (yearSelect && monthSelect) {
            const updateAllCalendar = () => {
                updatePanel('all', 'all');
            };
            yearSelect.addEventListener("change", updateAllCalendar);
            monthSelect.addEventListener("change", updateAllCalendar);

            // 이전달/다음달 버튼 이벤트
            const prevBtn = document.getElementById("calendarPrevBtn");
            const nextBtn = document.getElementById("calendarNextBtn");

            if (prevBtn) {
                prevBtn.addEventListener("click", () => {
                    let year = parseInt(yearSelect.value);
                    let month = parseInt(monthSelect.value);

                    month--;
                    if (month < 1) {
                        month = 12;
                        year--;
                    }

                    if (year >= 2025 && year <= 2027) {
                        yearSelect.value = year.toString();
                        monthSelect.value = month.toString();
                        updateAllCalendar();
                    }
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener("click", () => {
                    let year = parseInt(yearSelect.value);
                    let month = parseInt(monthSelect.value);

                    month++;
                    if (month > 12) {
                        month = 1;
                        year++;
                    }

                    if (year >= 2025 && year <= 2027) {
                        yearSelect.value = year.toString();
                        monthSelect.value = month.toString();
                        updateAllCalendar();
                    }
                });
            }

            // 주말 캘린더 이전/다음 달 버튼 이벤트
            const weekendPrevBtn = document.getElementById("weekendCalendarPrevBtn");
            const weekendNextBtn = document.getElementById("weekendCalendarNextBtn");

            if (weekendPrevBtn) {
                weekendPrevBtn.addEventListener("click", () => {
                    let year = parseInt(yearSelect.value);
                    let month = parseInt(monthSelect.value);

                    month--;
                    if (month < 1) {
                        month = 12;
                        year--;
                    }

                    if (year >= 2025 && year <= 2027) {
                        yearSelect.value = year.toString();
                        monthSelect.value = month.toString();
                        updateAllCalendar();
                    }
                });
            }

            if (weekendNextBtn) {
                weekendNextBtn.addEventListener("click", () => {
                    let year = parseInt(yearSelect.value);
                    let month = parseInt(monthSelect.value);

                    month++;
                    if (month > 12) {
                        month = 1;
                        year++;
                    }

                    if (year >= 2025 && year <= 2027) {
                        yearSelect.value = year.toString();
                        monthSelect.value = month.toString();
                        updateAllCalendar();
                    }
                });
            }

            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            if ([2025, 2026, 2027].includes(currentYear)) {
                yearSelect.value = currentYear.toString();
                monthSelect.value = currentMonth.toString();
            }

            updateAllCalendar();
        }

        // 각 카테고리 패널의 년/월 선택 이벤트
        {% for category in categories %}
        (function() {
            const categoryId = 'category-{{ category.id }}';
            const yearSelect = document.getElementById(`calendarYear-${categoryId}`);
            const monthSelect = document.getElementById(`calendarMonth-${categoryId}`);

            if (yearSelect && monthSelect) {
                const updateCategoryCalendar = () => {
                    updatePanel(categoryId, categoryId);
                };
                yearSelect.addEventListener("change", updateCategoryCalendar);
                monthSelect.addEventListener("change", updateCategoryCalendar);

                // 이전달/다음달 버튼 이벤트
                const prevBtn = document.getElementById(`calendarPrevBtn-${categoryId}`);
                const nextBtn = document.getElementById(`calendarNextBtn-${categoryId}`);

                if (prevBtn) {
                    prevBtn.addEventListener("click", () => {
                        let year = parseInt(yearSelect.value);
                        let month = parseInt(monthSelect.value);

                        month--;
                        if (month < 1) {
                            month = 12;
                            year--;
                        }

                        if (year >= 2025 && year <= 2027) {
                            yearSelect.value = year.toString();
                            monthSelect.value = month.toString();
                            updateCategoryCalendar();
                        }
                    });
                }

                if (nextBtn) {
                    nextBtn.addEventListener("click", () => {
                        let year = parseInt(yearSelect.value);
                        let month = parseInt(monthSelect.value);

                        month++;
                        if (month > 12) {
                            month = 1;
                            year++;
                        }

                        if (year >= 2025 && year <= 2027) {
                            yearSelect.value = year.toString();
                            monthSelect.value = month.toString();
                            updateCategoryCalendar();
                        }
                    });
                }

                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                if ([2025, 2026, 2027].includes(currentYear)) {
                    yearSelect.value = currentYear.toString();
                    monthSelect.value = currentMonth.toString();
                }
            }
        })();
        {% endfor %}
    });

    // 모바일: 주간 캘린더 전용 로직 (항상 실행, CSS로 표시/숨김 제어)
    document.addEventListener("DOMContentLoaded", function () {
            // 대회 데이터 로드 및 파싱
            const contestData = JSON.parse("{{ contest_data|default:'[]'|escapejs }}");

            const parseLocalDate = (value) => {
                if (!value) return null;
                const parts = value.split('-').map(Number);
                if (parts.length !== 3) return null;
                const [y, m, d] = parts;
                return new Date(y, m - 1, d);
            };

            const allContestData = contestData
                .map((contest) => {
                    const start = parseLocalDate(contest.schedule_start);
                    const end = parseLocalDate(contest.schedule_end) || start;
                    if (!start || !end || end < start) {
                        return null;
                    }
                    return {
                        ...contest,
                        schedule_start: start,
                        schedule_end: end,
                    };
                })
                .filter(Boolean);

            // 요일 이름 배열
            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];

            // 주간 캘린더 렌더링 함수 (크로스 슬라이드) - 전역 변수에 할당
            renderWeeklyCalendar = function(year, month, filteredContests, slideDirection = null) {
                const weeklyCalendarTitle = document.getElementById("weeklyCalendarTitle");
                const weeklyCalendarSlide = document.getElementById("weeklyCalendarSlide");

                if (!weeklyCalendarTitle || !weeklyCalendarSlide) {
                    return;
                }

                const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
                weeklyCalendarTitle.textContent = `${year}년 ${month}월`;

                // 슬라이드 애니메이션이 필요한 경우 (크로스 슬라이드)
                if (slideDirection) {
                    const container = weeklyCalendarSlide.parentElement;

                    // 현재 컨테이너 높이 고정
                    const currentHeight = container.offsetHeight;
                    container.style.height = currentHeight + 'px';

                    // 새 슬라이드 생성
                    const newSlide = document.createElement('div');
                    newSlide.className = 'weekly-calendar-slide';
                    newSlide.id = 'weeklyCalendarSlide-new';

                    // 새 슬라이드에 내용 렌더링
                    renderCalendarContent(newSlide, year, month, filteredContests, dayNames);

                    // 새 슬라이드 초기 위치 설정 (화면 밖)
                    if (slideDirection === 'next') {
                        // 다음달: 새 슬라이드를 오른쪽에 배치
                        newSlide.style.transform = 'translateX(100%)';
                    } else {
                        // 이전달: 새 슬라이드를 왼쪽에 배치
                        newSlide.style.transform = 'translateX(-100%)';
                    }

                    // 컨테이너에 새 슬라이드 추가
                    container.appendChild(newSlide);

                    // 새 슬라이드의 높이 측정
                    const newHeight = newSlide.offsetHeight;

                    // 다음 프레임에서 애니메이션 시작
                    requestAnimationFrame(() => {
                        // 컨테이너 높이를 새 슬라이드에 맞춤
                        container.style.height = newHeight + 'px';

                        // 현재 슬라이드와 새 슬라이드를 동시에 이동
                        if (slideDirection === 'next') {
                            // 다음달: 현재는 왼쪽으로, 새 것은 중앙으로
                            weeklyCalendarSlide.style.transform = 'translateX(-100%)';
                            newSlide.style.transform = 'translateX(0)';
                        } else {
                            // 이전달: 현재는 오른쪽으로, 새 것은 중앙으로
                            weeklyCalendarSlide.style.transform = 'translateX(100%)';
                            newSlide.style.transform = 'translateX(0)';
                        }
                    });

                    // 애니메이션 완료 후 이전 슬라이드 제거 및 높이 초기화
                    setTimeout(() => {
                        weeklyCalendarSlide.remove();
                        newSlide.id = 'weeklyCalendarSlide';
                        container.style.height = 'auto';
                    }, 400); // CSS transition 시간과 동일
                } else {
                    // 초기 로드 시 슬라이드 없이 바로 렌더링
                    weeklyCalendarSlide.style.transform = 'translateX(0)';
                    renderCalendarContent(weeklyCalendarSlide, year, month, filteredContests, dayNames);
                }
            }

            function renderCalendarContent(container, year, month, filteredContests, dayNames) {
                container.innerHTML = "";

                const firstDay = new Date(year, month - 1, 1);
                const lastDate = new Date(year, month, 0).getDate();
                const firstDayOfWeek = firstDay.getDay(); // 0=일요일

                // 해당 월의 주차별로 날짜 그룹화 (일요일~토요일 기준)
                const weeks = [];
                let currentWeek = [];

                // 첫 주의 시작일 계산 (이전 월의 날짜 포함)
                for (let i = firstDayOfWeek; i > 0; i--) {
                    const prevDate = new Date(year, month - 1, 1 - i);
                    currentWeek.push({ date: prevDate, isCurrentMonth: false });
                }

                // 현재 월의 모든 날짜 추가
                for (let day = 1; day <= lastDate; day++) {
                    const date = new Date(year, month - 1, day);
                    currentWeek.push({ date: date, isCurrentMonth: true });

                    // 토요일(6)이면 주차 완료
                    if (date.getDay() === 6) {
                        if (currentWeek.length > 0) {
                            weeks.push([...currentWeek]);
                        }
                        currentWeek = [];
                    }
                }

                // 마지막 주가 남아있으면 다음 달 날짜로 채워서 추가
                if (currentWeek.length > 0) {
                    const remainingDays = 7 - currentWeek.length;
                    for (let i = 1; i <= remainingDays; i++) {
                        const nextDate = new Date(year, month, i);
                        currentWeek.push({ date: nextDate, isCurrentMonth: false });
                    }
                    if (currentWeek.length > 0) {
                        weeks.push([...currentWeek]);
                    }
                }

                // 각 주차별로 블록 생성
                weeks.forEach((week, weekIndex) => {
                    // 주가 비어있거나 7일이 아니면 건너뛰기
                    if (!week || week.length !== 7 || !week[0] || !week[6]) {
                        return;
                    }

                    // 해당 주의 날짜 범위 계산
                    const weekStart = week[0].date;
                    const weekEnd = week[6].date;

                    const weekStartStr = `${weekStart.getMonth() + 1}/${weekStart.getDate()}`;
                    const weekEndStr = `${weekEnd.getMonth() + 1}/${weekEnd.getDate()}`;

                    // 해당 주에 속한 대회 찾기
                    const weekContests = [];
                    filteredContests.forEach(contest => {
                        if (!contest.schedule_start) return;

                        // 대회가 이 주에 포함되는지 확인
                        const contestStart = new Date(contest.schedule_start);
                        const contestEnd = contest.schedule_end ? new Date(contest.schedule_end) : contestStart;

                        // 주의 시작과 끝
                        const weekStartTime = new Date(weekStart).setHours(0, 0, 0, 0);
                        const weekEndTime = new Date(weekEnd).setHours(23, 59, 59, 999);

                        if (contestStart <= weekEndTime && contestEnd >= weekStartTime) {
                            // 대회가 시작하는 날짜 찾기
                            const contestDates = [];
                            for (let d = new Date(Math.max(contestStart, weekStart)); d <= Math.min(contestEnd, weekEnd); d.setDate(d.getDate() + 1)) {
                                contestDates.push(new Date(d));
                            }

                            if (contestDates.length > 0) {
                                weekContests.push({
                                    ...contest,
                                    displayDate: contestDates[0]
                                });
                            }
                        }
                    });

                    // 대회가 없는 주는 표시하지 않음
                    if (weekContests.length === 0) return;

                    // 주 블록 생성
                    const weekBlock = document.createElement("div");
                    weekBlock.className = "weekly-block";

                    // 주 헤더
                    const weekHeader = document.createElement("div");
                    weekHeader.className = "weekly-header";
                    weekHeader.innerHTML = `${month}월 ${weekIndex + 1}주 (${weekStartStr} ~ ${weekEndStr})`;
                    weekBlock.appendChild(weekHeader);

                    // 대회 리스트
                    const contestList = document.createElement("div");
                    contestList.className = "weekly-contest-list";

                    // 날짜순으로 정렬
                    weekContests.sort((a, b) => a.displayDate - b.displayDate);

                    weekContests.forEach(contest => {
                        const contestItem = document.createElement("a");
                        contestItem.className = "weekly-contest-item";
                        contestItem.href = `/badminton-tournament/${contest.slug}/`;

                        // 날짜 텍스트 생성
                        const contestStart = new Date(contest.schedule_start);
                        let contestEnd;
                        if (contest.schedule_end) {
                            contestEnd = new Date(contest.schedule_end);
                        } else {
                            contestEnd = new Date(contestStart);
                        }

                        // 시간 부분 제거하고 날짜만 비교
                        contestStart.setHours(0, 0, 0, 0);
                        contestEnd.setHours(0, 0, 0, 0);

                        // 1일 대회인지 2일 이상인지 확인
                        const daysDiff = Math.ceil((contestEnd - contestStart) / (1000 * 60 * 60 * 24));
                        let dateText = '';

                        if (daysDiff === 0) {
                            // 1일 대회: "토 12/20" 형식
                            const dayOfWeek = dayNames[contestStart.getDay()];
                            dateText = `${dayOfWeek} ${contestStart.getMonth() + 1}/${contestStart.getDate()}`;
                        } else {
                            // 2일 이상: "12/20-21 (토-일)" 형식
                            const startDayOfWeek = dayNames[contestStart.getDay()];
                            const endDayOfWeek = dayNames[contestEnd.getDay()];
                            const startMonth = contestStart.getMonth() + 1;
                            const startDate = contestStart.getDate();
                            const endMonth = contestEnd.getMonth() + 1;
                            const endDate = contestEnd.getDate();

                            if (startMonth === endMonth) {
                                dateText = `${startMonth}/${startDate}-${endDate} (${startDayOfWeek}-${endDayOfWeek})`;
                            } else {
                                dateText = `${startMonth}/${startDate}-${endMonth}/${endDate} (${startDayOfWeek}-${endDayOfWeek})`;
                            }
                        }

                        // 대회 정보 박스 (날짜 + 제목)
                        const infoDiv = document.createElement("div");
                        infoDiv.className = "weekly-contest-info";
                        const color = contest.category && contest.category.color ? contest.category.color : "#31AA60";
                        infoDiv.style.backgroundColor = color;
                        infoDiv.style.color = "#ffffff";
                        infoDiv.style.padding = "12px 16px";
                        infoDiv.style.borderRadius = "8px";

                        // 날짜 표시
                        const dateSpan = document.createElement("div");
                        dateSpan.className = "weekly-contest-info-date";
                        dateSpan.textContent = dateText;
                        infoDiv.appendChild(dateSpan);

                        // 제목 표시
                        const titleSpan = document.createElement("div");
                        titleSpan.className = "weekly-contest-info-title";
                        titleSpan.textContent = contest.title;
                        infoDiv.appendChild(titleSpan);

                        contestItem.appendChild(infoDiv);
                        contestList.appendChild(contestItem);
                    });

                    weekBlock.appendChild(contestList);
                    container.appendChild(weekBlock);
                });
            }

            // 현재 년월 저장 - 초기에는 가장 빠른 대회가 있는 월로 설정
            let currentYear = new Date().getFullYear();
            let currentMonth = new Date().getMonth() + 1;

            // 가장 빠른 대회 찾기
            if (allContestData.length > 0) {
                // schedule_start 기준으로 정렬하여 가장 빠른 대회 찾기
                const sortedContests = [...allContestData].sort((a, b) => a.schedule_start - b.schedule_start);
                const firstContest = sortedContests[0];
                if (firstContest && firstContest.schedule_start) {
                    currentYear = firstContest.schedule_start.getFullYear();
                    currentMonth = firstContest.schedule_start.getMonth() + 1;
                }
            }

            // 해당 월의 대회 필터링
            function getMonthContests(year, month) {
                return allContestData.filter((contest) => {
                    if (!contest.schedule_start) return false;

                    const startYear = contest.schedule_start.getFullYear();
                    const startMonth = contest.schedule_start.getMonth() + 1;

                    const endYear = contest.schedule_end ? contest.schedule_end.getFullYear() : startYear;
                    const endMonth = contest.schedule_end ? contest.schedule_end.getMonth() + 1 : startMonth;

                    // 시작일이 현재 월에 있는 경우
                    if (startYear === year && startMonth === month) {
                        return true;
                    }

                    // 종료일이 현재 월에 있는 경우
                    if (endYear === year && endMonth === month) {
                        return true;
                    }

                    // 대회가 현재 월을 포함하는 경우
                    const currentMonthStart = new Date(year, month - 1, 1);
                    const currentMonthEnd = new Date(year, month, 0);
                    if (contest.schedule_start <= currentMonthEnd && contest.schedule_end >= currentMonthStart) {
                        return true;
                    }

                    return false;
                });
            }

            // 모바일에서 대회 리스트를 월별로 필터링하는 함수
            function filterMobileContestList(year, month) {
                const contestItems = document.querySelectorAll('#contest-panel-list-all .contest-post-item');
                const currentMonthStart = new Date(year, month - 1, 1);
                const currentMonthEnd = new Date(year, month, 0);

                let visibleCount = 0;

                contestItems.forEach((item) => {
                    const scheduleStartStr = item.getAttribute('data-schedule-start');
                    const scheduleEndStr = item.getAttribute('data-schedule-end');

                    if (!scheduleStartStr) {
                        item.style.display = 'none';
                        return;
                    }

                    const scheduleStart = new Date(scheduleStartStr);
                    const scheduleEnd = scheduleEndStr ? new Date(scheduleEndStr) : scheduleStart;

                    const startYear = scheduleStart.getFullYear();
                    const startMonth = scheduleStart.getMonth() + 1;
                    const endYear = scheduleEnd.getFullYear();
                    const endMonth = scheduleEnd.getMonth() + 1;

                    // 시작일이 현재 월에 있거나, 종료일이 현재 월에 있거나, 대회가 현재 월을 포함하는 경우
                    const isInMonth = (
                        (startYear === year && startMonth === month) ||
                        (endYear === year && endMonth === month) ||
                        (scheduleStart <= currentMonthEnd && scheduleEnd >= currentMonthStart)
                    );

                    if (isInMonth) {
                        item.style.display = '';
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                // 빈 메시지 표시/숨김
                const emptyMessage = document.querySelector('#contest-panel-list-all .empty-message');
                const contestList = document.querySelector('#contest-panel-list-all .contest-post-list');

                if (visibleCount === 0) {
                    if (emptyMessage) emptyMessage.style.display = 'block';
                    if (contestList) contestList.style.display = 'none';
                } else {
                    if (emptyMessage) emptyMessage.style.display = 'none';
                    if (contestList) contestList.style.display = 'flex';
                }
            }

            // 주간 캘린더 이전/다음 달 버튼 이벤트
            const weeklyPrevBtn = document.getElementById("weeklyCalendarPrevBtn");
            const weeklyNextBtn = document.getElementById("weeklyCalendarNextBtn");

            if (weeklyPrevBtn) {
                weeklyPrevBtn.addEventListener("click", () => {
                    currentMonth--;
                    if (currentMonth < 1) {
                        currentMonth = 12;
                        currentYear--;
                    }

                    if (currentYear >= 2025 && currentYear <= 2027) {
                        const monthContests = getMonthContests(currentYear, currentMonth);
                        renderWeeklyCalendar(currentYear, currentMonth, monthContests, 'prev');
                        filterMobileContestList(currentYear, currentMonth);
                    }
                });
            }

            if (weeklyNextBtn) {
                weeklyNextBtn.addEventListener("click", () => {
                    currentMonth++;
                    if (currentMonth > 12) {
                        currentMonth = 1;
                        currentYear++;
                    }

                    if (currentYear >= 2025 && currentYear <= 2027) {
                        const monthContests = getMonthContests(currentYear, currentMonth);
                        renderWeeklyCalendar(currentYear, currentMonth, monthContests, 'next');
                        filterMobileContestList(currentYear, currentMonth);
                    }
                });
            }

            // 초기 렌더링
            if ([2025, 2026, 2027].includes(currentYear)) {
                const monthContests = getMonthContests(currentYear, currentMonth);
                renderWeeklyCalendar(currentYear, currentMonth, monthContests);
                filterMobileContestList(currentYear, currentMonth);
            }
    });

    // 화면 크기 변경 감지 및 모바일 탭 재초기화
    let resizeTimer;
    let lastIsMobile = isMobile;

    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            const currentIsMobile = checkMobile();

            // 모바일 <-> 데스크톱 전환이 발생한 경우
            if (currentIsMobile !== lastIsMobile) {
                lastIsMobile = currentIsMobile;
                isMobile = currentIsMobile;

                if (currentIsMobile) {
                    // 모바일로 전환: 탭 재초기화 + 웹 캘린더 숨김
                    initMobileTabs();
                    const calendarSection = document.querySelector('.calendar-section');
                    if (calendarSection) {
                        calendarSection.style.setProperty('display', 'none', 'important');
                        console.log('[Mobile] Resize: Web calendar hidden');
                    }
                } else {
                    // 데스크톱으로 전환: 웹 캘린더 표시
                    const calendarSection = document.querySelector('.calendar-section');
                    if (calendarSection) {
                        calendarSection.style.removeProperty('display');
                        console.log('[Desktop] Resize: Web calendar restored');
                    }
                }
            }
        }, 250); // 250ms 디바운스
    });

    // 필터 바텀시트 제어
    let currentOpenSheet = null;

    window.openFilterSheet = function(filterType) {
        const overlay = document.getElementById('filterOverlay');
        let sheet;

        if (filterType === 'qualifying') {
            sheet = document.getElementById('qualifyingSheet');
        } else if (filterType === 'sponsor') {
            sheet = document.getElementById('sponsorSheet');
        } else if (filterType === 'region') {
            sheet = document.getElementById('regionSheet');
        }

        if (!sheet) return;

        // 기존에 열린 시트가 있으면 닫기
        if (currentOpenSheet && currentOpenSheet !== sheet) {
            currentOpenSheet.style.transform = 'translateY(100%)';
            setTimeout(() => {
                currentOpenSheet.style.display = 'none';
            }, 300);
        }

        // 오버레이 표시
        overlay.style.display = 'block';
        setTimeout(() => {
            overlay.style.opacity = '1';
        }, 10);

        // 바텀시트 표시
        sheet.style.display = 'block';
        setTimeout(() => {
            sheet.style.transform = 'translateY(0)';
        }, 10);

        currentOpenSheet = sheet;

        // body 스크롤 방지
        document.body.style.overflow = 'hidden';
    }

    window.closeFilterSheet = function() {
        const overlay = document.getElementById('filterOverlay');

        if (currentOpenSheet) {
            currentOpenSheet.style.transform = 'translateY(100%)';
            setTimeout(() => {
                currentOpenSheet.style.display = 'none';
                currentOpenSheet = null;
            }, 300);
        }

        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 300);

        // body 스크롤 복원
        document.body.style.overflow = '';
    }

    // ESC 키로 닫기
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && currentOpenSheet) {
            closeFilterSheet();
        }
    });

    // 배너 슬라이드 기능
    document.addEventListener('DOMContentLoaded', function() {
        const bannerWrappers = document.querySelectorAll('.banner-wrapper');

        bannerWrappers.forEach(function(wrapper) {
            const container = wrapper.querySelector('[data-banner-container]');
            const items = container.querySelectorAll('.badmintok-banner-item');
            const prevBtn = wrapper.querySelector('[data-banner-prev]');
            const nextBtn = wrapper.querySelector('[data-banner-next]');

            if (items.length <= 1) {
                // 배너가 1개 이하면 버튼 숨기기
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
                return;
            }

            let currentIndex = 0;

            function slideToBanner(index) {
                const item = items[index];
                if (item) {
                    // scrollIntoView 대신 컨테이너의 scrollLeft를 직접 조작
                    const scrollPosition = item.offsetLeft;
                    container.scrollTo({ left: scrollPosition, behavior: 'smooth' });
                }
            }

            function nextBanner() {
                currentIndex = (currentIndex + 1) % items.length;
                slideToBanner(currentIndex);
            }

            function prevBanner() {
                currentIndex = (currentIndex - 1 + items.length) % items.length;
                slideToBanner(currentIndex);
            }

            // 버튼 클릭 이벤트
            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    prevBanner();
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    nextBanner();
                });
            }

            // 5초마다 자동 슬라이드
            const autoSlideInterval = setInterval(nextBanner, 5000);

            // 사용자가 수동으로 스크롤하면 인터벌 초기화
            let scrollTimeout;
            container.addEventListener('scroll', function() {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(function() {
                    // 현재 보이는 배너의 인덱스를 업데이트
                    const containerRect = container.getBoundingClientRect();
                    items.forEach(function(item, index) {
                        const itemRect = item.getBoundingClientRect();
                        if (Math.abs(itemRect.left - containerRect.left) < 10) {
                            currentIndex = index;
                        }
                    });
                }, 150);
            });
        });
    });
})();
</script>
{% endblock %}
