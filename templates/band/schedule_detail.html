{% extends "base.html" %}

{% block title %}{{ schedule.title }} - 참석하기 - 배드민톡{% endblock %}

{% block content %}
<section class="section" style="position: relative;">
    <div class="container" style="position: relative; min-height: 400px; margin-top: 0;">
        <div style="max-width: 800px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
            <!-- 헤더 -->
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                <a href="{% url 'band:detail' band.id %}?tab=flash" style="text-decoration: none; color: #1e293b; font-size: 20px; line-height: 1;">&lt;</a>
                <h1 id="scheduleTitle" style="margin: 0; font-size: 20px; font-weight: 700; color: #1e293b; flex: 1;">{{ schedule.title|default:band.name }}</h1>
                {% if is_admin %}
                <form method="post" action="{% url 'band:schedule_toggle_close' band.id schedule.id %}" style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" style="padding: 8px 16px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; {% if schedule.is_closed %}background: #10b981; color: white;{% else %}background: #f1f5f9; color: #64748b;{% endif %}">
                        {% if schedule.is_closed %}모집 열기{% else %}모집 마감{% endif %}
                    </button>
                </form>
                {% endif %}
            </div>

            {% if schedule.is_closed %}
            <div style="margin-bottom: 16px; padding: 12px 16px; background: #fef2f2; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <span style="font-size: 14px; font-weight: 500; color: #ef4444;">모집이 마감되었습니다</span>
            </div>
            {% endif %}
            
            <!-- 번개 이미지 슬라이드 -->
            {% if schedule.images.all %}
                <div style="margin-bottom: 24px; border-radius: 12px; overflow: hidden; background: #f8fafc;">
                    {% if schedule.images.all|length > 1 %}
                        <!-- 슬라이드 형식 (2장 이상) -->
                        <div class="schedule-image-slider-detail" style="position: relative; width: 100%; aspect-ratio: 3/4; overflow: hidden;">
                            <div class="schedule-slider-track-detail" style="display: flex; width: {% widthratio schedule.images.all|length 1 100 %}%; height: 100%; transition: transform 0.3s ease;">
                                {% for img in schedule.images.all %}
                                    <div class="schedule-slide-detail" style="width: {% widthratio 100 schedule.images.all|length 1 %}%; height: 100%; flex-shrink: 0;">
                                        <img src="{{ img.image.url }}" alt="번개 이미지 {{ forloop.counter }}" style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="schedule-nav schedule-nav-prev" data-schedule-prev aria-label="이전 이미지" style="position: absolute; top: 50%; left: 8px; transform: translateY(-50%); width: 32px; height: 32px; border: none; border-radius: 50%; background: rgba(0, 0, 0, 0.5); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s ease; z-index: 10; font-size: 18px; line-height: 1; font-weight: 600;">‹</button>
                            <button type="button" class="schedule-nav schedule-nav-next" data-schedule-next aria-label="다음 이미지" style="position: absolute; top: 50%; right: 8px; transform: translateY(-50%); width: 32px; height: 32px; border: none; border-radius: 50%; background: rgba(0, 0, 0, 0.5); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s ease; z-index: 10; font-size: 18px; line-height: 1; font-weight: 600;">›</button>
                            <div class="schedule-slider-dots-detail" style="position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; z-index: 10;">
                                {% for img in schedule.images.all %}
                                    <button type="button" class="schedule-dot-detail" data-slide="{{ forloop.counter0 }}" style="width: 8px; height: 8px; border-radius: 50%; border: none; background: {% if forloop.first %}white{% else %}rgba(255, 255, 255, 0.5){% endif %}; cursor: pointer; padding: 0;"></button>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <!-- 단일 이미지 -->
                        <img src="{{ schedule.images.first.image.url }}" alt="번개 이미지" style="width: 100%; aspect-ratio: 3/4; object-fit: cover;">
                    {% endif %}
                </div>
            {% endif %}
            
            <!-- 번개 정보 -->
            <div style="margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 12px;">
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: white; border-radius: 8px; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </span>
                        <div>
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 2px;">일정</div>
                            <div style="font-size: 15px; font-weight: 600; color: #1e293b;">{{ schedule.start_datetime|date:"Y년 m월 d일 (D)" }}</div>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: white; border-radius: 8px; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </span>
                        <div>
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 2px;">시간</div>
                            <div style="font-size: 15px; font-weight: 600; color: #1e293b;">{{ schedule.start_datetime|time:"H:i" }}{% if schedule.end_datetime %} ~ {{ schedule.end_datetime|time:"H:i" }}{% endif %}</div>
                        </div>
                    </div>

                    {% if schedule.location %}
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: white; border-radius: 8px; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                        </span>
                        <div>
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 2px;">위치</div>
                            <div style="font-size: 15px; font-weight: 600; color: #1e293b;">{{ schedule.location }}</div>
                        </div>
                    </div>
                    {% endif %}

                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: white; border-radius: 8px; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </span>
                        <div>
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 2px;">참가 인원</div>
                            <div style="font-size: 15px; font-weight: 600; color: #1e293b;">{{ schedule.current_participants }}명{% if schedule.max_participants %} / {{ schedule.max_participants }}명{% endif %}</div>
                        </div>
                    </div>

                    {% if meeting_cost %}
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: white; border-radius: 8px; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                        </span>
                        <div>
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 2px;">참가비</div>
                            <div style="font-size: 15px; font-weight: 600; color: #1e293b;">{{ meeting_cost }}원</div>
                        </div>
                    </div>
                    {% endif %}

                    {% if schedule.bank_account %}
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: white; border-radius: 8px; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                        </span>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 2px;">입금 계좌</div>
                            <div
                                id="bankAccountText"
                                data-account="{{ schedule.bank_account }}"
                                onclick="copyBankAccount()"
                                style="font-size: 15px; font-weight: 600; color: #1e293b; cursor: pointer; display: flex; align-items: center; gap: 8px;"
                            >
                                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ schedule.bank_account }}</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0;">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if schedule.description %}
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: white; border-radius: 8px; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                        </span>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 2px;">설명</div>
                            <div id="scheduleDescription" data-description-original="{{ schedule.description|escapejs }}" style="font-size: 14px; color: #1e293b; line-height: 1.6; white-space: pre-wrap;">{{ schedule.description|linebreaks }}</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 참가자 목록 -->
            {% if approved_participants %}
            <div style="margin-bottom: 24px; background: #f8fafc; border-radius: 12px; overflow: hidden;">
                <div style="padding: 16px 20px; border-bottom: 1px solid #e2e8f0;">
                    <h3 style="margin: 0; font-size: 15px; font-weight: 600; color: #1e293b;">참가자 <span style="color: var(--brand);">{{ approved_participants|length }}명</span></h3>
                </div>
                <div style="background: white;">
                    {% for app in approved_participants %}
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 20px;{% if not forloop.last %} border-bottom: 1px solid #f1f5f9;{% endif %}">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            {% if app.user.profile_image %}
                                <img src="{{ app.user.profile_image.url }}" alt="{{ app.user.real_name }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                            {% else %}
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--brand); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 600;">{{ app.user.real_name|first }}</div>
                            {% endif %}
                            <span style="font-size: 15px; font-weight: 500; color: #1e293b;">{{ app.user.real_name }}</span>
                        </div>
                        {% if app.user.profile and app.user.profile.badminton_level %}
                        <span style="font-size: 13px; font-weight: 500; color: #64748b; background: #f1f5f9; padding: 4px 10px; border-radius: 12px;">{{ app.user.profile.get_badminton_level_display }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- 신청 상태 및 버튼 -->
            <div style="margin-bottom: 24px;">
                {% if user_application %}
                    {% if user_application.status == "pending" %}
                        <div style="padding: 16px; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: 600; color: #92400e;">대기 중</span>
                            </div>
                            <p style="margin: 0; font-size: 13px; color: #78350f;">참가 신청이 대기 중입니다. 승인을 기다려주세요.</p>
                        </div>
                        <form method="post" action="{% url 'band:schedule_application_cancel' band.id schedule.id %}" style="margin-bottom: 12px;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-ghost" style="width: 100%; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 500; color: #64748b;">신청 취소</button>
                        </form>
                    {% elif user_application.status == "approved" %}
                        <div style="padding: 16px; background: #d1fae5; border: 1px solid #6ee7b7; border-radius: 8px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: 600; color: #065f46;">승인됨</span>
                            </div>
                            <p style="margin: 0; font-size: 13px; color: #047857;">참가 신청이 승인되었습니다. 번개에 참석해주세요!</p>
                        </div>
                        <form method="post" action="{% url 'band:schedule_application_cancel' band.id schedule.id %}" style="margin-bottom: 12px;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-ghost" style="width: 100%; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 500; color: #64748b;">참가 취소</button>
                        </form>
                    {% elif user_application.status == "rejected" %}
                        <div style="padding: 16px; background: #fee2e2; border: 1px solid #fca5a5; border-radius: 8px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: 600; color: #991b1b;">거부됨</span>
                            </div>
                            <p style="margin: 0; font-size: 13px; color: #7f1d1d;">
                                {% if user_application.rejection_reason %}
                                    사유: {{ user_application.rejection_reason }}
                                {% else %}
                                    참가 신청이 거부되었습니다.
                                {% endif %}
                            </p>
                        </div>
                    {% elif user_application.status == "cancelled" %}
                        <div style="padding: 16px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 16px;">
                            <p style="margin: 0; font-size: 13px; color: #475569;">참가 신청이 취소되었습니다.</p>
                        </div>
                        {% if not schedule.is_closed %}
                        <a href="{% url 'band:schedule_apply' band.id schedule.id %}" class="btn btn-primary" style="display: block; width: 100%; text-align: center; padding: 12px; background: var(--brand); color: white; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500;">다시 신청하기</a>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <!-- 신청 가능한 경우 -->
                    {% if schedule.is_closed %}
                        <div style="padding: 16px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 16px;">
                            <p style="margin: 0; font-size: 14px; color: #475569; text-align: center;">모집이 마감되었습니다.</p>
                        </div>
                    {% elif schedule.max_participants and schedule.current_participants >= schedule.max_participants %}
                        <div style="padding: 16px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 16px;">
                            <p style="margin: 0; font-size: 14px; color: #475569; text-align: center;">참가 인원이 마감되었습니다.</p>
                        </div>
                    {% else %}
                        <a href="{% url 'band:schedule_apply' band.id schedule.id %}" class="btn btn-primary" style="display: block; width: 100%; text-align: center; padding: 12px; background: var(--brand); color: white; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500;">참가 신청하기</a>
                    {% endif %}
                {% endif %}
            </div>
            
            <!-- 관리자용: 대기 중인 신청 목록 -->
            {% if can_manage and pending_applications %}
            <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #e2e8f0;">
                <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700; color: #1e293b;">대기 중인 신청 ({{ pending_applications|length }}건)</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    {% for app in pending_applications %}
                        <div style="padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    {% if app.user.profile_image %}
                                        <img src="{{ app.user.profile_image.url }}" alt="{{ app.user.real_name }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                                    {% else %}
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--brand); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 600;">{{ app.user.real_name|first }}</div>
                                    {% endif %}
                                    <div>
                                        <div style="font-size: 15px; font-weight: 600; color: #1e293b;">
                                            {{ app.user.real_name }}{% if app.user.profile and app.user.profile.badminton_level %} / {{ app.user.profile.get_badminton_level_display }}{% endif %}
                                        </div>
                                        <div style="font-size: 12px; color: #64748b;">{{ app.applied_at|date:"Y.m.d H:i" }}</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <form method="post" action="{% url 'band:schedule_application_approve' band.id schedule.id app.id %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-primary" style="padding: 8px 16px; font-size: 13px; background: var(--brand); color: white; border-radius: 6px; border: none; cursor: pointer;">승인</button>
                                    </form>
                                    <a href="{% url 'band:schedule_application_reject' band.id schedule.id app.id %}" class="btn btn-ghost" style="padding: 8px 16px; font-size: 13px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-decoration: none; color: #64748b;">거부</a>
                                </div>
                            </div>
                            {% if app.notes %}
                                <div style="padding: 8px 12px; background: #fff; border-radius: 6px; font-size: 13px; color: #475569; white-space: pre-wrap;">{{ app.notes }}</div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<style>
    .schedule-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
        z-index: 10;
        font-size: 18px;
        line-height: 1;
        font-weight: 600;
    }

    .schedule-nav:hover {
        background: rgba(0, 0, 0, 0.7);
    }

    .schedule-nav:active {
        transform: translateY(-50%) scale(0.95);
    }

    .schedule-nav-prev {
        left: 8px;
    }

    .schedule-nav-next {
        right: 8px;
    }

    @keyframes fadeInOut {
        0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
        15% { opacity: 1; transform: translateX(-50%) translateY(0); }
        85% { opacity: 1; transform: translateX(-50%) translateY(0); }
        100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    }
</style>

<script>
    // 입금 계좌 복사 기능
    function copyBankAccount() {
        const bankAccountEl = document.getElementById('bankAccountText');
        if (!bankAccountEl) return;

        const accountText = bankAccountEl.dataset.account;

        navigator.clipboard.writeText(accountText).then(function() {
            // 복사 성공 토스트 메시지
            const toast = document.createElement('div');
            toast.textContent = '계좌번호가 복사되었습니다';
            toast.style.cssText = 'position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 8px; font-size: 14px; z-index: 9999; animation: fadeInOut 2s ease-in-out forwards;';
            document.body.appendChild(toast);

            setTimeout(function() {
                toast.remove();
            }, 2000);
        }).catch(function(err) {
            console.error('복사 실패:', err);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 제목에서 날짜 패턴(예: "- 2025-12-09") 제거
        const titleEl = document.getElementById('scheduleTitle');
        if (titleEl) {
            const cleanedTitle = titleEl.textContent.replace(/\s*[-–]\s*\d{4}-\d{2}-\d{2}$/, '').trim();
            titleEl.textContent = cleanedTitle;
        }

        // 설명에서 "참가비/비용/입장료"로 시작하는 줄을 제거하여 중복 표시를 방지
        const descEl = document.getElementById('scheduleDescription');
        if (descEl) {
            const raw = descEl.dataset.descriptionOriginal || '';
            // \u000D\u000A, \u000D, \u000A를 모두 실제 줄바꿈으로 변환
            const normalized = raw.replace(/\\u000D\\u000A/g, '\n').replace(/\\u000D/g, '').replace(/\\u000A/g, '\n').replace(/\\n/g, '\n');
            // 줄바꿈으로 분리하고 참가비 관련 줄 제거
            const lines = normalized.split(/\r?\n/);
            const cleaned = lines
                .filter(line => {
                    const trimmed = line.trim();
                    // "참가비:", "비용:", "입장료:"로 시작하는 줄 제거
                    return !trimmed.match(/^(참가비|비용|입장료)[:\s]/);
                })
                .join('\n')
                .trim();
            if (cleaned) {
                // 줄바꿈을 <br>로 변환하여 HTML로 표시
                descEl.innerHTML = cleaned.replace(/\n/g, '<br>');
            } else {
                // 모든 내용이 제거된 경우 요소 숨김
                descEl.parentElement.style.display = 'none';
            }
        }

        const slider = document.querySelector('.schedule-image-slider-detail');
        if (!slider) return;
        
        const track = slider.querySelector('.schedule-slider-track-detail');
        const slides = slider.querySelectorAll('.schedule-slide-detail');
        const dots = slider.querySelectorAll('.schedule-dot-detail');
        const prevBtn = slider.querySelector('[data-schedule-prev]');
        const nextBtn = slider.querySelector('[data-schedule-next]');
        
        if (slides.length <= 1) {
            if (prevBtn) prevBtn.style.display = 'none';
            if (nextBtn) nextBtn.style.display = 'none';
            return;
        }
        
        let currentSlide = 0;
        let autoSlideInterval;
        
        function updateSlide(index) {
            currentSlide = index;
            const slideWidth = 100 / slides.length;
            track.style.transform = `translateX(-${currentSlide * slideWidth}%)`;
            
            dots.forEach((d, i) => {
                d.style.background = i === currentSlide ? 'white' : 'rgba(255, 255, 255, 0.5)';
            });
        }
        
        function nextSlide() {
            currentSlide = (currentSlide + 1) % slides.length;
            updateSlide(currentSlide);
        }
        
        function prevSlide() {
            currentSlide = (currentSlide - 1 + slides.length) % slides.length;
            updateSlide(currentSlide);
        }
        
        // 도트 클릭
        dots.forEach((dot, index) => {
            dot.addEventListener('click', function() {
                updateSlide(index);
            });
        });
        
        // 화살표 버튼 클릭
        if (prevBtn) {
            prevBtn.addEventListener('click', function() {
                prevSlide();
            });
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', function() {
                nextSlide();
            });
        }
        
        // 자동 슬라이드 (3초마다)
        autoSlideInterval = setInterval(nextSlide, 3000);
        
        // 마우스 호버 시 자동 슬라이드 일시 정지
        slider.addEventListener('mouseenter', function() {
            clearInterval(autoSlideInterval);
        });
        
        slider.addEventListener('mouseleave', function() {
            autoSlideInterval = setInterval(nextSlide, 3000);
        });
    });
</script>
{% endblock %}

