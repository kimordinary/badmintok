{% extends "base.html" %}
{% load community_filters %}

{% block title %}{{ post.title }} - 배드민톡{% endblock %}

{% block content %}
<!-- 토스피드 스타일 헤더 -->
<header class="article-header" style="position: relative; height: 60vh; min-height: 500px; display: flex; align-items: flex-end; overflow: hidden; margin-top: -24px;">
    <!-- 배경 이미지 -->
    <div class="header-image" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1;">
        {% if post.thumbnail %}
            <img src="{{ post.thumbnail.url }}" alt="{{ post.title }}" style="width: 100%; height: 100%; object-fit: cover;">
        {% elif post.images.exists %}
            <img src="{{ post.images.first.image.url }}" alt="{{ post.title }}" style="width: 100%; height: 100%; object-fit: cover;">
        {% elif post.content|extract_first_image %}
            <img src="{{ post.content|extract_first_image }}" alt="{{ post.title }}" style="width: 100%; height: 100%; object-fit: cover;">
        {% else %}
            <!-- 기본 배경 (그라데이션) -->
            <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
        {% endif %}
    </div>

    <!-- 그라데이션 오버레이 -->
    <div class="header-gradient" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(180deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.8) 100%); z-index: 2;"></div>

    <!-- 헤더 콘텐츠 -->
    <div class="header-content" style="position: relative; z-index: 3; width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 24px 100px; text-align: center;">
        <h1 style="margin: 0 0 32px 0; font-size: 52px; font-weight: 700; color: #ffffff; line-height: 1.3; text-shadow: 0 2px 12px rgba(0,0,0,0.4);">
            {{ post.title }}
        </h1>

        <div style="display: flex; gap: 32px; align-items: center; flex-wrap: wrap; color: #ffffff; justify-content: center;">
            <!-- 날짜 -->
            <div style="display: flex; align-items: center; gap: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #ffffff; opacity: 0.95;">
                    <path d="M13 11.761c0 .033-.016.062-.019.094a.848.848 0 01-.041.199.964.964 0 01-.174.328c-.044.053-.09.1-.144.144-.025.02-.04.049-.067.067l-4.726 3.15a1 1 0 01-1.109-1.664L11 11.226v-4.67a1 1 0 012 0v5.205zM12 1.5C6.201 1.5 1.5 6.201 1.5 12S6.201 22.5 12 22.5 22.5 17.799 22.5 12 17.799 1.5 12 1.5z"/>
                </svg>
                <span style="font-size: 16px; opacity: 0.95; font-weight: 400;">{{ post.created_at|date:"Y.m.d" }}</span>
            </div>

            <!-- 작성자 -->
            <div style="display: flex; align-items: center; gap: 8px;">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 18px; height: 18px; fill: #ffffff; opacity: 0.95;">
                    <path d="m19.288 1.586 3.125 3.12c.782.781.782 2.049 0 2.83l-2.108 2.104-5.959-5.95 2.108-2.104c.783-.782 2.051-.782 2.834 0z"></path>
                    <path d="m1 22.4.003-4.89c0-.292.116-.572.323-.778l11.775-11.758 5.956 5.946-11.776 11.759c-.206.206-.486.322-.777.322h-4.904c-.332 0-.6-.269-.6-.6z"></path>
                </svg>
                <span style="font-size: 16px; font-weight: 500; opacity: 0.95;">{{ post.author.activity_name }}</span>
            </div>

            <!-- 조회수 -->
            <div style="display: flex; align-items: center; gap: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #ffffff; opacity: 0.95;">
                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                </svg>
                <span style="font-size: 16px; opacity: 0.95; font-weight: 400;">{{ post.view_count }}</span>
            </div>
        </div>

        <!-- 아래로 스크롤 버튼 -->
        <button onclick="scrollToContent()" style="position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); background: transparent; border: none; cursor: pointer; padding: 12px; animation: bounce 2s infinite;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 30px; height: 30px; fill: #ffffff; opacity: 0.8;">
                <path d="M6.6 9.8c0-.2.1-.5.3-.6.4-.4.9-.4 1.3 0L12 13l3.9-3.9c.4-.4.9-.4 1.3 0s.4.9 0 1.3l-4.5 4.5c-.4.4-.9.4-1.3 0l-4.5-4.5c-.2-.2-.3-.4-.3-.6"/>
            </svg>
        </button>
    </div>
</header>

<style>
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateX(-50%) translateY(0);
        }
        40% {
            transform: translateX(-50%) translateY(-10px);
        }
        60% {
            transform: translateX(-50%) translateY(-5px);
        }
    }

    /* 반응형 */
    @media (max-width: 768px) {
        .article-header {
            height: 50vh !important;
            min-height: 400px !important;
        }

        .header-content h1 {
            font-size: 32px !important;
        }

        .header-content > div {
            gap: 20px !important;
        }

        .header-content span {
            font-size: 14px !important;
        }

        .header-content svg {
            width: 16px !important;
            height: 16px !important;
        }
    }
</style>

<script>
    function scrollToContent() {
        document.getElementById('article-content').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }
</script>

<!-- 게시글 본문 -->
<section id="article-content" style="padding: 0; overflow: visible; position: relative;">
    <div>
    <div class="container" style="max-width: 1200px; margin: 40px auto; padding: 0 20px;">
        <div style="max-width: 800px; margin: 0 auto;">
            <!-- 카테고리 -->
            {% if post.category %}
            <div style="margin-bottom: 24px;">
                <span style="display: inline-block; padding: 6px 14px; background: #f1f5f9; color: var(--brand); border-radius: 20px; font-size: 13px; font-weight: 600;">
                    {{ post.get_category_display }}
                </span>
            </div>
            {% endif %}

            <!-- 게시글 내용 -->
            <article style="margin-bottom: 48px; line-height: 1.9; color: #1e293b;">
                <div class="post-content" id="post-content-body" style="word-wrap: break-word;">
                    {{ post.content|safe }}
                </div>
            </article>

            <!-- 좋아요 / 공유 버튼 -->
            <div style="display: flex; gap: 12px; margin-bottom: 48px; padding: 32px 0; border-bottom: 1px solid #e2e8f0;">
                <form action="{% url 'community:like' post.slug %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit"
                            style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; background: #fff; color: #64748b; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s;">
                        {% if user in post.likes.all %}
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="#ef4444" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        {% else %}
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        {% endif %}
                        <span>좋아요 {{ post.like_count }}</span>
                    </button>
                </form>
                <button type="button"
                        id="shareButton"
                        onclick="copyPostLink()"
                        style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; background: #fff; color: #64748b; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                        <polyline points="16 6 12 2 8 6"></polyline>
                        <line x1="12" y1="2" x2="12" y2="15"></line>
                    </svg>
                    <span>공유</span>
                </button>
            </div>

            <!-- 댓글 섹션 -->
            <div style="margin-top: 48px;">
                <h2 style="margin-bottom: 24px; font-size: 24px; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>사용자와 소통해요, 배드민톡!</span>
                </h2>

                {% if user.is_authenticated %}
                <!-- 댓글 작성 폼 -->
                <div style="padding: 24px; margin-bottom: 32px;">
                    <form method="post" action="{% url 'community:comment_create' post.slug %}">
                        {% csrf_token %}
                        <textarea name="content" placeholder="댓글을 입력하세요..." required
                                  style="width: 100%; min-height: 100px; padding: 16px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 15px; line-height: 1.6; resize: none; font-family: inherit;"></textarea>
                        <div style="margin-top: 12px; text-align: right;">
                            <button type="submit" style="padding: 12px 24px; background: var(--brand); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                댓글 남기기
                            </button>
                        </div>
                    </form>
                </div>
                {% else %}
                <div style="background: #f8fafc; border-radius: 12px; padding: 32px; margin-bottom: 32px; text-align: center;">
                    <p style="color: #64748b; margin-bottom: 16px;">로그인하시면 댓글을 남기실 수 있습니다.</p>
                    <a href="{% url 'accounts:login' %}" style="display: inline-block; padding: 12px 24px; background: var(--brand); color: white; border-radius: 8px; text-decoration: none; font-weight: 600;">로그인</a>
                </div>
                {% endif %}

                <!-- 댓글 목록 -->
                <div style="margin-top: 32px;">
                    {% for comment in comments %}
                    <div style="padding: 24px; background: #f8fafc; border-radius: 12px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <img src="{{ comment.author.profile_image_url }}" alt="{{ comment.author.activity_name }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <span style="font-weight: 600; color: #1e293b;">{{ comment.author.activity_name }}</span>
                                </div>
                                <p style="margin: 0 0 16px 0; color: #475569; line-height: 1.7; white-space: pre-wrap;">{{ comment.content }}</p>

                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <form method="post" action="{% url 'community:comment_like' comment.id %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" style="background: none; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; color: #64748b; font-size: 14px; padding: 4px 8px; border-radius: 6px; transition: all 0.2s;">
                                            {% if user in comment.likes.all %}
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                            </svg>
                                            {% else %}
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                            </svg>
                                            {% endif %}
                                            <span>{{ comment.like_count }}</span>
                                        </button>
                                    </form>

                                    <button onclick="toggleReplyForm({{ comment.id }})" style="background: none; border: none; cursor: pointer; color: #64748b; font-size: 14px; padding: 4px 8px; border-radius: 6px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                        </svg>
                                        <span>답글</span>
                                    </button>

                                    {% if user == comment.author %}
                                    <form method="post" action="{% url 'community:comment_delete' comment.id %}" style="display: inline;" onsubmit="return confirm('댓글을 삭제하시겠습니까?');">
                                        {% csrf_token %}
                                        <button type="submit" style="background: none; border: none; cursor: pointer; color: #ef4444; font-size: 14px; padding: 4px 8px; border-radius: 6px;">
                                            삭제
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>

                                <!-- 대댓글 작성 폼 -->
                                {% if user.is_authenticated %}
                                <div id="reply-form-{{ comment.id }}" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                                    <form method="post" action="{% url 'community:comment_create' post.slug %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                        <textarea name="content" placeholder="답글을 입력하세요..." required
                                                  style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; line-height: 1.6; resize: none; font-family: inherit; margin-bottom: 8px;"></textarea>
                                        <div style="text-align: right;">
                                            <button type="button" onclick="toggleReplyForm({{ comment.id }})" style="padding: 8px 16px; background: #fff; color: #64748b; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; margin-right: 8px;">
                                                취소
                                            </button>
                                            <button type="submit" style="padding: 8px 16px; background: var(--brand); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
                                                답글 달기
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                {% endif %}

                                <!-- 대댓글 목록 -->
                                {% for reply in comment.replies.all %}
                                {% if not reply.is_deleted %}
                                <div style="margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                                    <div style="display: flex; align-items: start; gap: 12px;">
                                        <img src="{{ reply.author.profile_image_url }}" alt="{{ reply.author.activity_name }}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                                <span style="font-weight: 600; color: #1e293b; font-size: 14px;">{{ reply.author.activity_name }}</span>
                                            </div>
                                            <p style="margin: 0 0 12px 0; color: #475569; font-size: 14px; line-height: 1.7; white-space: pre-wrap;">{{ reply.content }}</p>

                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <form method="post" action="{% url 'community:comment_like' reply.id %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" style="background: none; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; color: #64748b; font-size: 13px; padding: 2px 6px; border-radius: 4px;">
                                                        {% if user in reply.likes.all %}
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                                        </svg>
                                                        {% else %}
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                                        </svg>
                                                        {% endif %}
                                                        <span>{{ reply.like_count }}</span>
                                                    </button>
                                                </form>

                                                {% if user == reply.author %}
                                                <form method="post" action="{% url 'community:comment_delete' reply.id %}" style="display: inline;" onsubmit="return confirm('답글을 삭제하시겠습니까?');">
                                                    {% csrf_token %}
                                                    <button type="submit" style="background: none; border: none; cursor: pointer; color: #ef4444; font-size: 13px; padding: 2px 6px; border-radius: 4px;">
                                                        삭제
                                                    </button>
                                                </form>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                <div style="padding: 64px 32px; text-align: center; color: #94a3b8; background: #f8fafc; border-radius: 12px;">
                        <p style="font-size: 15px;">첫 댓글을 남겨보세요!</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- 추천 콘텐츠 -->
                {% if recommended_posts %}
                <div style="margin-top: 64px; padding-top: 48px; border-top: 1px solid #e2e8f0;">
                    <h2 style="margin-bottom: 24px; font-size: 28px; font-weight: 700; color: #1e293b;">
                        추천 콘텐츠
                    </h2>
                    <div class="recommended-posts-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                        {% for rec_post in recommended_posts %}
                        <a href="{% url 'badmintok_detail' rec_post.slug %}" class="recommended-post-card" style="text-decoration: none; color: inherit; display: block;">
                            <div class="recommended-post-inner" style="background: #fff; border-radius: 12px; overflow: hidden; height: 100%; display: flex; flex-direction: column;">
                                <!-- 썸네일 -->
                                <div class="recommended-post-image" style="position: relative; width: 100%; padding-top: 56.25%; overflow: hidden; background: #f8fafc; border-radius: 12px;">
                                    <span style="box-sizing: border-box; display: block; overflow: hidden; width: initial; height: initial; background: none; opacity: 1; border: 0px; margin: 0px; padding: 0px; position: absolute; inset: 0px; border-radius: 12px;">
                                        {% if rec_post.thumbnail %}
                                            <img src="{{ rec_post.thumbnail.url }}" alt="{{ rec_post.title }}" decoding="async" style="position: absolute; inset: 0px; box-sizing: border-box; padding: 0px; border: none; margin: auto; display: block; width: 0px; height: 0px; min-width: 100%; max-width: 100%; min-height: 100%; max-height: 100%; object-fit: cover; transition: transform 0.3s ease; border-radius: 12px;">
                                        {% elif rec_post.images.exists %}
                                            <img src="{{ rec_post.images.first.image.url }}" alt="{{ rec_post.title }}" decoding="async" style="position: absolute; inset: 0px; box-sizing: border-box; padding: 0px; border: none; margin: auto; display: block; width: 0px; height: 0px; min-width: 100%; max-width: 100%; min-height: 100%; max-height: 100%; object-fit: cover; transition: transform 0.3s ease; border-radius: 12px;">
                                        {% else %}
                                            <div style="position: absolute; inset: 0px; box-sizing: border-box; padding: 0px; border: none; margin: auto; display: block; width: 0px; height: 0px; min-width: 100%; max-width: 100%; min-height: 100%; max-height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;"></div>
                                        {% endif %}
                                    </span>
                                </div>
                                <!-- 콘텐츠 -->
                                <div class="recommended-post-content" style="padding: 16px; flex: 1; display: flex; flex-direction: column; background: #fff;">
                                    {% if rec_post.category %}
                                    <span style="display: inline-block; font-size: 12px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">{{ rec_post.category.name }}</span>
                                    {% endif %}
                                    <h4 class="recommended-post-title" style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600; color: #1e293b; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; flex: 1;">{{ rec_post.title }}</h4>
                                    <time style="font-size: 12px; color: #94a3b8;">{{ rec_post.created_at|date:"Y.m.d" }}</time>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <style>
        /* 목차 스타일 */
        .wpj-jtoc--toc {
            background: #f8fafc;
            border: none;
            border-radius: 12px;
            margin: 32px 0;
            overflow: hidden;
            position: relative;
            z-index: 1;
            width: 40%;
        }

        .wpj-jtoc--header {
            padding: 16px 20px;
            background: #f8fafc;
            border-bottom: none;
        }

        .wpj-jtoc--header-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .wpj-jtoc--title {
            flex: 1;
        }

        .wpj-jtoc--title-label {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        .wpj-jtoc--toggle-wrap {
            display: flex;
            align-items: center;
        }

        .wpj-jtoc--chevron {
            width: 20px;
            height: 20px;
            color: #64748b;
            cursor: pointer;
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }

        .wpj-jtoc--toc.collapsed .wpj-jtoc--chevron {
            transform: rotate(180deg);
        }

        .wpj-jtoc--body {
            padding: 16px 20px;
            max-height: 500px;
            overflow-y: auto;
            transition: max-height 0.3s, padding 0.3s;
        }

        .wpj-jtoc--toc.collapsed .wpj-jtoc--body {
            max-height: 0;
            padding: 0 20px;
            overflow: hidden;
        }

        .wpj-jtoc--items {
            list-style: none;
            padding: 0 0 0 20px !important;
            margin: 0 !important;
            counter-reset: toc-counter;
        }

        .wpj-jtoc--item {
            margin: 8px 0;
        }

        .wpj-jtoc--item-content {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            position: relative;
            z-index: 1;
        }

        .wpj-jtoc--item-content::before {
            counter-increment: toc-counter;
            content: counter(toc-counter) ".";
            color: var(--brand);
            font-weight: 600;
            font-size: 18px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .wpj-jtoc--item-content a {
            color: #64748b !important;
            text-decoration: none !important;
            font-size: 18px;
            line-height: 1.6;
            transition: color 0.2s;
            flex: 1;
            cursor: pointer;
            pointer-events: auto;
            position: relative;
            z-index: 1;
        }

        .wpj-jtoc--item-content a:hover {
            color: var(--brand) !important;
            text-decoration: none !important;
        }

        .wpj-jtoc--item.active .wpj-jtoc--item-content a {
            color: var(--brand) !important;
            text-decoration: none !important;
        }

        .wpj-jtoc--item.active .wpj-jtoc--item-content::before {
            color: var(--brand);
        }

        .wpj-jtoc--body::-webkit-scrollbar {
            width: 4px;
        }

        .wpj-jtoc--body::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        /* 추천 콘텐츠 스타일 - 토스피드 스타일 */
        .recommended-post-image {
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        .recommended-post-image img {
            transition: transform 0.3s ease;
        }
        /* 이미지만 hover 효과 적용 - 확대 효과 */
        .recommended-post-card:hover .recommended-post-image img {
            transform: scale(1.08);
        }
        /* 텍스트 영역 hover 효과 */
        .recommended-post-content {
            position: relative;
            z-index: 1;
            pointer-events: none;
        }
        .recommended-post-content * {
            pointer-events: auto;
        }
        .recommended-post-title {
            transition: color 0.2s ease;
            cursor: pointer;
        }
        .recommended-post-card:hover .recommended-post-title {
            color: var(--brand) !important;
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .wpj-jtoc--toc {
                width: 100% !important;
            }
            .recommended-posts-grid {
                grid-template-columns: 1fr !important;
            }
        }

        .post-content {
            font-size: 17px;
            line-height: 1.9;
            color: #1e293b;
        }
            .post-content h1, .post-content h2, .post-content h3 {
                margin: 48px 0 24px 0;
                font-weight: 700;
                color: #0f172a;
                line-height: 1.4;
            }
            .post-content h1 { font-size: 32px; }
            .post-content h2 {
                font-size: 28px;
                margin-left: 0;
                padding-left: 20px;
                position: relative;
            }
            .post-content h2::before {
                content: '';
                position: absolute;
                left: 0;
                top: 4px;
                bottom: 4px;
                width: 6px;
                background: var(--brand);
                border-radius: 999px;
            }
            .post-content h3 {
                font-size: 24px;
                padding-left: 20px;
                position: relative;
                margin-left: 0;
            }
            .post-content h3::before {
                content: '•';
                position: absolute;
                left: 0;
                color: var(--brand);
                font-size: 24px;
                line-height: 1.4;
            }
            .post-content p {
                margin: 24px 0;
                letter-spacing: -0.01em;
            }
            .post-content img {
                max-width: 100%;
                height: auto;
                border-radius: 12px;
                margin: 32px 0;
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            }
            .post-content ul, .post-content ol {
                margin: 24px 0;
                padding-left: 28px;
            }
            .post-content li {
                margin: 12px 0;
                line-height: 1.8;
            }
            .post-content blockquote {
                border-left: 4px solid var(--brand);
                padding-left: 20px;
                margin: 32px 0;
                color: #64748b;
                font-style: italic;
                font-size: 18px;
            }
            .post-content code {
                background: #f1f5f9;
                padding: 3px 8px;
                border-radius: 4px;
                font-family: 'Courier New', monospace;
                font-size: 15px;
                color: #e11d48;
            }
            .post-content pre {
                background: #f8fafc;
                padding: 20px;
                border-radius: 12px;
                overflow-x: auto;
                margin: 32px 0;
                border: 1px solid #e2e8f0;
            }
            .post-content pre code {
                background: none;
                padding: 0;
                color: #1e293b;
            }
            .post-content a:not(.wpj-jtoc--item-content a) {
                color: var(--brand);
                text-decoration: underline;
                text-underline-offset: 3px;
            }
            .post-content a:not(.wpj-jtoc--item-content a):hover {
                color: var(--brand-700);
            }

            /* 첫 번째 단락 강조 */
            .post-content > p:first-of-type {
                font-size: 19px;
                font-weight: 500;
                color: #0f172a;
            }
        </style>

    <script>
        // CSRF 토큰 가져오기
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // 답글 폼 토글
        function toggleReplyForm(commentId) {
            const replyForm = document.getElementById('reply-form-' + commentId);
            if (replyForm.style.display === 'none' || replyForm.style.display === '') {
                replyForm.style.display = 'block';
            } else {
                replyForm.style.display = 'none';
            }
        }

        // 게시글 좋아요 AJAX 처리
        document.addEventListener('DOMContentLoaded', function() {
            const postLikeForm = document.querySelector('form[action*="like"]');
            if (postLikeForm && postLikeForm.action.includes('/like/')) {
                postLikeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const form = e.target;
                    const button = form.querySelector('button[type="submit"]');
                    const likeCountSpan = button.querySelector('span:last-child');
                    
                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams(new FormData(form))
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 좋아요 수 업데이트
                            likeCountSpan.textContent = '좋아요 ' + data.like_count;
                            
                            // 아이콘만 업데이트 (하트만 빨간색으로)
                            const svg = button.querySelector('svg');
                            if (data.liked) {
                                svg.setAttribute('fill', '#ef4444');
                                svg.setAttribute('stroke', '#ef4444');
                            } else {
                                svg.setAttribute('fill', 'none');
                                svg.setAttribute('stroke', 'currentColor');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('좋아요 처리 중 오류가 발생했습니다.');
                    });
                });
            }

            // 댓글 좋아요 AJAX 처리
            attachCommentEventListeners();

            // 댓글 작성 폼 AJAX 처리
            const commentForm = document.querySelector('form[action*="comment/create"]');
            if (commentForm && !commentForm.querySelector('input[name="parent_id"]')) {
                commentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const form = e.target;
                    const textarea = form.querySelector('textarea[name="content"]');
                    const content = textarea.value.trim();
                    
                    if (!content) {
                        alert('댓글 내용을 입력해주세요.');
                        return;
                    }

                    const button = form.querySelector('button[type="submit"]');
                    const originalText = button.textContent;
                    button.disabled = true;
                    button.textContent = '작성 중...';

                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams(new FormData(form))
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 폼 초기화
                            textarea.value = '';
                            button.disabled = false;
                            button.textContent = originalText;
                            
                            // 댓글 목록에 추가
                            addCommentToList(data.comment, false);
                            
                            // 댓글 개수 업데이트
                            updateCommentCount();
                        } else {
                            alert(data.error || '댓글 작성에 실패했습니다.');
                            button.disabled = false;
                            button.textContent = originalText;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('댓글 작성 중 오류가 발생했습니다.');
                        button.disabled = false;
                        button.textContent = originalText;
                    });
                });
            }

        });

        // 댓글을 목록에 추가하는 함수
        function addCommentToList(commentData, isReply) {
            const commentsList = document.querySelector('div[style*="margin-top: 32px"]');
            
            if (!commentsList) return;

            const commentHTML = createCommentHTML(commentData, false);
            const emptyMessage = commentsList.querySelector('div[style*="padding: 64px"]');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            commentsList.insertAdjacentHTML('beforeend', commentHTML);
            
            // 새로 추가된 댓글에 이벤트 리스너 추가
            attachCommentEventListeners();
        }

        // 대댓글을 목록에 추가하는 함수
        function addReplyToList(commentData, parentId) {
            const parentComment = document.querySelector(`[data-comment-id="${parentId}"]`);
            if (!parentComment) return;

            const commentContent = parentComment.querySelector('div[style*="flex: 1"]');
            const existingReplies = commentContent.querySelectorAll('div[style*="margin-top: 16px"][style*="padding: 16px"]');
            
            let repliesContainer = null;
            if (existingReplies.length > 0) {
                repliesContainer = existingReplies[existingReplies.length - 1].parentElement;
            }
            
            if (!repliesContainer) {
                repliesContainer = document.createElement('div');
                repliesContainer.className = 'replies-container';
                commentContent.appendChild(repliesContainer);
            }
            
            repliesContainer.insertAdjacentHTML('beforeend', createCommentHTML(commentData, true));
            
            // 새로 추가된 대댓글에 이벤트 리스너 추가
            attachCommentEventListeners();
        }

        // 댓글 이벤트 리스너 추가 함수
        function attachCommentEventListeners() {
            // 댓글 좋아요
            document.querySelectorAll('form[action*="comment"][action*="like"]').forEach(function(form) {
                if (!form.dataset.listenerAttached) {
                    form.dataset.listenerAttached = 'true';
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        const button = form.querySelector('button[type="submit"]');
                        const likeCountSpan = button.querySelector('span:last-child');
                        const svg = button.querySelector('svg');
                        
                        fetch(form.action, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrftoken,
                                'X-Requested-With': 'XMLHttpRequest',
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams(new FormData(form))
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                likeCountSpan.textContent = data.like_count;
                                if (data.liked) {
                                    svg.setAttribute('fill', 'currentColor');
                                } else {
                                    svg.setAttribute('fill', 'none');
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                    });
                }
            });

            // 대댓글 작성 폼
            document.querySelectorAll('form[action*="comment/create"]').forEach(function(form) {
                if (form.querySelector('input[name="parent_id"]') && !form.dataset.listenerAttached) {
                    form.dataset.listenerAttached = 'true';
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        const formEl = e.target;
                        const textarea = formEl.querySelector('textarea[name="content"]');
                        const content = textarea.value.trim();
                        const parentId = formEl.querySelector('input[name="parent_id"]').value;
                        
                        if (!content) {
                            alert('답글 내용을 입력해주세요.');
                            return;
                        }

                        const button = formEl.querySelector('button[type="submit"]');
                        const originalText = button.textContent;
                        button.disabled = true;
                        button.textContent = '작성 중...';

                        fetch(formEl.action, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrftoken,
                                'X-Requested-With': 'XMLHttpRequest',
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams(new FormData(formEl))
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                textarea.value = '';
                                toggleReplyForm(parentId);
                                button.disabled = false;
                                button.textContent = originalText;
                                addReplyToList(data.comment, parentId);
                            } else {
                                alert(data.error || '답글 작성에 실패했습니다.');
                                button.disabled = false;
                                button.textContent = originalText;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('답글 작성 중 오류가 발생했습니다.');
                            button.disabled = false;
                            button.textContent = originalText;
                        });
                    });
                }
            });
        }

        // 댓글 HTML 생성 함수
        function createCommentHTML(commentData, isReply) {
            const isAuthor = commentData.is_author || false;
            const deleteButton = isAuthor ? `
                <form method="post" action="/community/comment/${commentData.id}/delete/" style="display: inline;" onsubmit="return confirm('댓글을 삭제하시겠습니까?');">
                    <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                    <button type="submit" style="background: none; border: none; cursor: pointer; color: #ef4444; font-size: ${isReply ? '13px' : '14px'}; padding: ${isReply ? '2px 6px' : '4px 8px'}; border-radius: ${isReply ? '4px' : '6px'};">삭제</button>
                </form>
            ` : '';

            if (isReply) {
                return `
                    <div style="margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <div style="width: 32px; height: 32px; border-radius: 50%; background: #94a3b8; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 13px; flex-shrink: 0;">
                                ${commentData.author_initial}
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <span style="font-weight: 600; color: #1e293b; font-size: 14px;">${commentData.author_name}</span>
                                </div>
                                <p style="margin: 0 0 12px 0; color: #475569; font-size: 14px; line-height: 1.7; white-space: pre-wrap;">${escapeHtml(commentData.content)}</p>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <form method="post" action="/community/comment/${commentData.id}/like/" style="display: inline;">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                                        <button type="submit" style="background: none; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; color: #64748b; font-size: 13px; padding: 2px 6px; border-radius: 4px;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                            </svg>
                                            <span>${commentData.like_count}</span>
                                        </button>
                                    </form>
                                    ${deleteButton}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div data-comment-id="${commentData.id}" style="padding: 24px; background: #f8fafc; border-radius: 12px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--brand); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 16px; flex-shrink: 0;">
                                ${commentData.author_initial}
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <span style="font-weight: 600; color: #1e293b;">${commentData.author_name}</span>
                                </div>
                                <p style="margin: 0 0 16px 0; color: #475569; line-height: 1.7; white-space: pre-wrap;">${escapeHtml(commentData.content)}</p>
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <form method="post" action="/community/comment/${commentData.id}/like/" style="display: inline;">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                                        <button type="submit" style="background: none; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; color: #64748b; font-size: 14px; padding: 4px 8px; border-radius: 6px; transition: all 0.2s;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                            </svg>
                                            <span>${commentData.like_count}</span>
                                        </button>
                                    </form>
                                    <button onclick="toggleReplyForm(${commentData.id})" style="background: none; border: none; cursor: pointer; color: #64748b; font-size: 14px; padding: 4px 8px; border-radius: 6px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                        </svg>
                                        <span>답글</span>
                                    </button>
                                    ${deleteButton}
                                </div>
                                <div id="reply-form-${commentData.id}" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                                    <form method="post" action="${document.querySelector('form[action*="comment/create"]')?.action || window.location.pathname.replace(/\/$/, '') + '/comment/create/'}">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                                        <input type="hidden" name="parent_id" value="${commentData.id}">
                                        <textarea name="content" placeholder="답글을 입력하세요..." required style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; line-height: 1.6; resize: none; font-family: inherit; margin-bottom: 8px;"></textarea>
                                        <div style="text-align: right;">
                                            <button type="button" onclick="toggleReplyForm(${commentData.id})" style="padding: 8px 16px; background: #fff; color: #64748b; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; margin-right: 8px;">취소</button>
                                            <button type="submit" style="padding: 8px 16px; background: var(--brand); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">답글 달기</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // HTML 이스케이프 함수
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 댓글 개수 업데이트 함수
        function updateCommentCount() {
            const commentsList = document.querySelector('div[style*="margin-top: 32px"]');
            if (commentsList) {
                const commentCount = commentsList.querySelectorAll('div[data-comment-id]').length;
                // 댓글 개수 표시가 있다면 업데이트 (현재는 제목에 개수가 없으므로 주석 처리)
                // const commentCountSpan = document.querySelector('h2 span');
                // if (commentCountSpan) {
                //     commentCountSpan.textContent = commentCount;
                // }
            }
        }

        function copyPostLink() {
            const postUrl = window.location.href;

            navigator.clipboard.writeText(postUrl).then(function() {
                const shareButton = document.getElementById('shareButton');
                const originalText = shareButton.innerHTML;
                shareButton.innerHTML = '<span>✓</span><span>복사됨</span>';
                shareButton.style.background = 'var(--brand)';
                shareButton.style.color = '#fff';
                shareButton.style.borderColor = 'var(--brand)';

                setTimeout(function() {
                    shareButton.innerHTML = originalText;
                    shareButton.style.background = '#fff';
                    shareButton.style.color = '#64748b';
                    shareButton.style.borderColor = '#e2e8f0';
                }, 2000);
            }).catch(function(err) {
                const textarea = document.createElement('textarea');
                textarea.value = postUrl;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    const shareButton = document.getElementById('shareButton');
                    const originalText = shareButton.innerHTML;
                    shareButton.innerHTML = '<span>✓</span><span>복사됨</span>';
                    shareButton.style.background = 'var(--brand)';
                    shareButton.style.color = '#fff';
                    shareButton.style.borderColor = 'var(--brand)';
                    setTimeout(function() {
                        shareButton.innerHTML = originalText;
                        shareButton.style.background = '#fff';
                        shareButton.style.color = '#64748b';
                        shareButton.style.borderColor = '#e2e8f0';
                    }, 2000);
                } catch (err) {
                    alert('링크 복사에 실패했습니다: ' + err);
                }
                document.body.removeChild(textarea);
            });
        }

        // 목차 생성 및 첫 번째 h2 위에 삽입
        document.addEventListener('DOMContentLoaded', function() {
            const content = document.getElementById('post-content-body');
            if (!content) return;

            // h2 태그 찾기
            const headings = content.querySelectorAll('h2');
            if (headings.length === 0) return;

            // 첫 번째 h2 태그 찾기
            const firstHeading = headings[0];

            // 목차 HTML 생성
            const tocHTML = `
                <div class="wpj-jtoc--toc">
                    <div class="wpj-jtoc--header">
                        <div class="wpj-jtoc--header-main">
                            <div class="wpj-jtoc--title">
                                <span class="wpj-jtoc--title-label">목차</span>
                            </div>
                            <div class="wpj-jtoc--toggle-wrap">
                                <svg class="wpj-jtoc--chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 15l-6-6-6 6"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="wpj-jtoc--body">
                        <nav class="wpj-jtoc--nav">
                            <ol class="wpj-jtoc--items" id="toc-items"></ol>
                        </nav>
                    </div>
                </div>
            `;

            // 첫 번째 h2 앞에 목차 삽입
            firstHeading.insertAdjacentHTML('beforebegin', tocHTML);

            // 목차 아이템 생성
            const tocItems = document.getElementById('toc-items');
            headings.forEach(function(heading, index) {
                // ID가 없으면 생성
                if (!heading.id) {
                    heading.id = 'heading-' + index;
                }

                // 목차 아이템 생성
                const li = document.createElement('li');
                li.className = 'wpj-jtoc--item --jtoc-h2';

                const itemContent = document.createElement('div');
                itemContent.className = 'wpj-jtoc--item-content';
                itemContent.setAttribute('data-depth', '2');

                const link = document.createElement('a');
                link.href = '#' + heading.id;
                link.textContent = heading.textContent;
                link.title = heading.textContent;
                link.setAttribute('data-numeration', index + 1);

                // 클릭 이벤트
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    heading.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                });

                itemContent.appendChild(link);
                li.appendChild(itemContent);
                tocItems.appendChild(li);
            });

            // 토글 기능 (chevron 클릭)
            const chevron = document.querySelector('.wpj-jtoc--chevron');
            const tocContainer = document.querySelector('.wpj-jtoc--toc');

            if (chevron && tocContainer) {
                chevron.addEventListener('click', function() {
                    tocContainer.classList.toggle('collapsed');
                });
            }

            // Intersection Observer로 현재 보고 있는 섹션 감지
            const observerOptions = {
                root: null,
                rootMargin: '-20% 0px -60% 0px',
                threshold: 0
            };

            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) {
                        // 모든 active 클래스 제거
                        document.querySelectorAll('.wpj-jtoc--item').forEach(function(item) {
                            item.classList.remove('active');
                        });

                        // 현재 보고 있는 섹션에 해당하는 목차 항목에 active 클래스 추가
                        const headingId = entry.target.id;
                        const tocLink = document.querySelector(`.wpj-jtoc--item-content a[href="#${headingId}"]`);
                        if (tocLink) {
                            const tocItem = tocLink.closest('.wpj-jtoc--item');
                            if (tocItem) {
                                tocItem.classList.add('active');
                            }
                        }
                    }
                });
            }, observerOptions);

            // 모든 h2 태그 관찰
            headings.forEach(function(heading) {
                observer.observe(heading);
            });
        });
    </script>
    </div>
    <!-- 메인 콘텐츠 끝 -->

</section>
{% endblock %}
