name: Deploy to AWS Lightsail

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env.prod file
        run: |
          cat > .env.prod << EOF
          # Django 설정
          DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
          DJANGO_DEBUG=${DJANGO_DEBUG:-False}
          DJANGO_ALLOWED_HOSTS=${{ secrets.DJANGO_ALLOWED_HOSTS }}
          
          # 데이터베이스 설정
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE=${MYSQL_DATABASE:-badmintok}
          MYSQL_USER=${MYSQL_USER:-badmintok_user}
          MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
          
          DB_HOST=${DB_HOST:-db}
          DB_PORT=${DB_PORT:-3306}
          DB_NAME=${DB_NAME:-badmintok}
          DB_USER=${DB_USER:-badmintok_user}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          # 카카오 로그인 설정
          KAKAO_REST_API_KEY=${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }}
          
          # Nginx 설정
          NGINX_HTTP_PORT=${NGINX_HTTP_PORT:-80}
          NGINX_HTTPS_PORT=${NGINX_HTTPS_PORT:-443}
          
          # Gunicorn 설정
          GUNICORN_WORKERS=${GUNICORN_WORKERS:-3}
          GUNICORN_TIMEOUT=${GUNICORN_TIMEOUT:-120}
          GUNICORN_LOG_LEVEL=${GUNICORN_LOG_LEVEL:-info}
          GUNICORN_MAX_REQUESTS=${GUNICORN_MAX_REQUESTS:-1000}
          GUNICORN_MAX_REQUESTS_JITTER=${GUNICORN_MAX_REQUESTS_JITTER:-50}
          
          # 시간대
          TZ=${TZ:-Asia/Seoul}
          EOF
        env:
          DJANGO_DEBUG: ${{ secrets.DJANGO_DEBUG }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          NGINX_HTTP_PORT: ${{ secrets.NGINX_HTTP_PORT }}
          NGINX_HTTPS_PORT: ${{ secrets.NGINX_HTTPS_PORT }}
          GUNICORN_WORKERS: ${{ secrets.GUNICORN_WORKERS }}
          GUNICORN_TIMEOUT: ${{ secrets.GUNICORN_TIMEOUT }}
          GUNICORN_LOG_LEVEL: ${{ secrets.GUNICORN_LOG_LEVEL }}
          GUNICORN_MAX_REQUESTS: ${{ secrets.GUNICORN_MAX_REQUESTS }}
          GUNICORN_MAX_REQUESTS_JITTER: ${{ secrets.GUNICORN_MAX_REQUESTS_JITTER }}
          TZ: ${{ secrets.TZ }}

      - name: Prepare deployment package
        run: |
          # .env.prod 파일이 생성되었는지 확인
          if [ ! -f .env.prod ]; then
            echo "ERROR: .env.prod file not found!"
            exit 1
          fi
          
          echo "Creating deployment package..."
          
          # 임시 디렉토리에 필요한 파일들 복사
          mkdir -p deploy-temp
          cp -r accounts badmintok band community contests templates static nginx mysql scripts deploy-temp/ 2>/dev/null || true
          cp Dockerfile docker-compose.prod.yml entrypoint.sh requirements.txt manage.py deploy-temp/ 2>/dev/null || true
          cp .env.prod env.prod.example deploy-temp/ 2>/dev/null || true
          
          # 불필요한 파일 제거
          find deploy-temp -name "*.pyc" -delete 2>/dev/null || true
          find deploy-temp -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          find deploy-temp -name "*.log" -delete 2>/dev/null || true
          find deploy-temp -name ".DS_Store" -delete 2>/dev/null || true
          find deploy-temp -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
          find deploy-temp -name ".env" -not -name ".env.prod" -not -name "env.prod.example" -delete 2>/dev/null || true
          
          # tar 압축 파일 생성
          cd deploy-temp
          tar -czf ../deploy.tar.gz .
          cd ..
          
          # .env.prod 파일이 tar에 포함되었는지 확인
          if ! tar -tzf deploy.tar.gz | grep -q '\.env\.prod$'; then
            echo "ERROR: .env.prod file not found in deploy.tar.gz!"
            echo "Files in archive:"
            tar -tzf deploy.tar.gz | grep -E '(\.env|env\.prod)' || echo "No .env files found"
            exit 1
          fi
          
          echo ".env.prod file successfully included in deploy.tar.gz"
          rm -rf deploy-temp

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          port: ${{ secrets.LIGHTSAIL_SSH_PORT }}
          source: "deploy.tar.gz"
          target: "/tmp/"

      - name: Setup and Deploy on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          port: ${{ secrets.LIGHTSAIL_SSH_PORT }}
          script: |
            set -e
            
            echo "=== Starting deployment ==="
            
            USER_HOME="/home/${{ secrets.LIGHTSAIL_USER }}"
            if [ "${{ secrets.LIGHTSAIL_USER }}" = "ec2-user" ]; then
              USER_HOME="/home/ec2-user"
            fi
            
            mkdir -p $USER_HOME/badmintok
            cd $USER_HOME/badmintok
            
            if [ -f docker-compose.prod.yml ]; then
              echo "Stopping existing containers..."
              docker-compose -f docker-compose.prod.yml --env-file .env.prod down || true
            fi
            
            echo "Extracting deployment package..."
            tar -xzf /tmp/deploy.tar.gz
            rm -f /tmp/deploy.tar.gz
            
            if [ ! -f .env.prod ]; then
              echo "ERROR: .env.prod file not found!"
              echo "Please check GitHub Secrets configuration."
              exit 1
            fi
            
            echo ".env.prod file found and ready"
            chmod 600 .env.prod
            
            # .env.prod 파일 내용 확인 (비밀번호 제외)
            echo "Verifying .env.prod file..."
            if ! grep -q "DJANGO_SECRET_KEY=" .env.prod || ! grep -q "MYSQL_ROOT_PASSWORD=" .env.prod; then
              echo "ERROR: .env.prod file is missing required variables!"
              exit 1
            fi
            
            echo "Building Docker images..."
            # Buildx 없이 빌드하도록 DOCKER_BUILDKIT=0 설정
            DOCKER_BUILDKIT=0 docker-compose -f docker-compose.prod.yml --env-file .env.prod build --no-cache
            
            echo "Starting containers..."
            # 데이터베이스와 웹 컨테이너만 먼저 시작 (nginx는 나중에)
            docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d db
            
            echo "Waiting for database to be ready..."
            sleep 10
            
            # 웹 컨테이너 시작
            docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d web
            
            echo "Waiting for web container to start..."
            sleep 30
            
            # 웹 컨테이너 로그 확인
            echo "Checking web container logs..."
            docker-compose -f docker-compose.prod.yml --env-file .env.prod logs web | tail -100 || true
            
            # Nginx 로그 확인 (문제 진단용)
            echo "Checking Nginx logs..."
            docker-compose -f docker-compose.prod.yml --env-file .env.prod logs nginx | tail -50 || true
            
            # 웹 컨테이너가 실행 중인지 확인
            if ! docker ps | grep -q "badmintok-web-prod"; then
              echo "ERROR: Web container is not running!"
              docker-compose -f docker-compose.prod.yml --env-file .env.prod logs web
              exit 1
            fi
            
            # Certbot 및 Nginx 시작
            echo "Starting Certbot and Nginx..."
            docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d certbot nginx
            
            echo "Waiting for Nginx to start..."
            sleep 5
            
            # Nginx 로그 확인
            echo "Checking Nginx logs..."
            docker-compose -f docker-compose.prod.yml --env-file .env.prod logs nginx | tail -50 || true
            
            # Nginx 컨테이너 상태 확인
            if ! docker ps | grep -q "badmintok-nginx-prod"; then
              echo "ERROR: Nginx container is not running!"
              echo "Checking Nginx logs for errors..."
              docker-compose -f docker-compose.prod.yml --env-file .env.prod logs nginx
              echo "Checking if port 80 is in use..."
              sudo netstat -tulpn | grep :80 || sudo ss -tulpn | grep :80 || true
              exit 1
            fi
            
            echo "Waiting for all services..."
            sleep 10
            
            echo "Checking service health..."
            docker-compose -f docker-compose.prod.yml --env-file .env.prod ps
            
            echo "Running database migrations..."
            docker-compose -f docker-compose.prod.yml --env-file .env.prod exec -T web python manage.py migrate --noinput || true
            
            echo "Collecting static files..."
            docker-compose -f docker-compose.prod.yml --env-file .env.prod exec -T web python manage.py collectstatic --noinput --clear || true
            
            echo "Restarting Nginx..."
            docker-compose -f docker-compose.prod.yml --env-file .env.prod restart nginx || true
            
            echo "Cleaning up unused Docker images..."
            docker image prune -f || true
            
            echo "=== Deployment completed! ==="

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          port: ${{ secrets.LIGHTSAIL_SSH_PORT }}
          script: |
            echo "=== Verifying deployment ==="
            
            USER_HOME="/home/${{ secrets.LIGHTSAIL_USER }}"
            if [ "${{ secrets.LIGHTSAIL_USER }}" = "ec2-user" ]; then
              USER_HOME="/home/ec2-user"
            fi
            cd $USER_HOME/badmintok
            
            docker-compose -f docker-compose.prod.yml ps
            
            sleep 5
            curl -f http://localhost/health/ || echo "Health check failed, but deployment may still be in progress"
            
            echo "=== Verification completed ==="
